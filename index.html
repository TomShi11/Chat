<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- æ ¸å¿ƒï¼šå®Œç¾é€‚é…ç§»åŠ¨ç«¯ï¼Œç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…åˆ˜æµ·å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>11s Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“œ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-paper: #f7f1e3;      /* æ›´æŸ”å’Œçš„ç¾Šçš®çº¸è‰² */
            --bg-sidebar: #f0e6d2;    
            --bg-accent: #c0b298;     
            --text-main: #2c241b;     
            --text-light: #857a6e;
            --border: #dcd3c1;
            
            --msg-sent: #e2dcc8;      
            --msg-received: #ffffff;  
            
            --btn-primary: #5c4b3c;
            --btn-hover: #3e3228;
            --blue-read: #3498db;     /* å·²è¯»å›æ‰§è“ */

            --shadow-sm: 0 2px 8px rgba(44, 36, 27, 0.05);
            --shadow-md: 0 8px 24px rgba(44, 36, 27, 0.12);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-paper);
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "STSong", serif;
            height: 100vh; height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯æµè§ˆå™¨é«˜åº¦ */
            display: flex; justify-content: center; overflow: hidden;
        }

        #app { width: 100%; height: 100%; display: flex; position: relative; max-width: 1600px; background: #fff; box-shadow: 0 0 50px rgba(0,0,0,0.05); }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: 300px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; z-index: 20;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .brand {
            font-size: 20px; font-weight: bold; margin-bottom: 25px; 
            display: flex; align-items: center; justify-content: space-between; color: var(--text-main);
        }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: 0.3s; }
        .conn-dot.online { background: #2ecc71; box-shadow: 0 0 6px #2ecc71; }

        .section-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 12px; color: var(--text-light); font-weight: bold; letter-spacing: 1px; }
        .icon-btn { cursor: pointer; padding: 4px; font-size: 16px; transition: 0.2s; } .icon-btn:hover { color: var(--text-main); transform: scale(1.1); }

        .friend-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .friend-item {
            padding: 12px; border-radius: var(--radius); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 12px; border: 1px solid transparent;
        }
        .friend-item:hover { background: rgba(255,255,255,0.4); }
        .friend-item.active { background: #fff; border-color: rgba(0,0,0,0.05); box-shadow: var(--shadow-sm); }
        
        .avatar {
            width: 44px; height: 44px; background: var(--bg-accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; 
            color: #fff; font-size: 18px; flex-shrink: 0; text-transform: uppercase;
        }
        .friend-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .friend-top { display: flex; justify-content: space-between; align-items: center; }
        .friend-name { font-weight: bold; font-size: 15px; }
        .friend-time { font-size: 10px; opacity: 0.5; font-family: sans-serif; }
        .friend-msg { font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8; }
        .unread-dot { min-width: 18px; height: 18px; background: #e74c3c; color: white; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; padding: 0 5px; font-family: sans-serif; }

        .user-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .user-name { font-weight: bold; font-size: 14px; }

        /* --- èŠå¤©ä¸»çª—å£ --- */
        .main-chat {
            flex: 1; display: flex; flex-direction: column; position: relative; z-index: 10;
            background-color: var(--bg-paper);
            background-image: radial-gradient(#d4cbb8 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .chat-header {
            height: 64px; padding: 0 24px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 16px; font-size: 17px; font-weight: bold;
            background: rgba(253, 246, 227, 0.95); backdrop-filter: blur(12px);
        }
        .back-btn { display: none; font-size: 22px; cursor: pointer; padding: 4px; }

        .chat-area { flex: 1; overflow-y: auto; padding: 20px 30px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: auto; }

        /* æ¶ˆæ¯æ°”æ³¡ & åŠ¨ç”» */
        .msg-row { display: flex; flex-direction: column; max-width: 70%; position: relative; animation: msgSlideUp 0.3s cubic-bezier(0.2, 0.9, 0.3, 1) forwards; }
        @keyframes msgSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-row.sent { align-self: flex-end; align-items: flex-end; }
        .msg-row.received { align-self: flex-start; align-items: flex-start; }

        .bubble {
            padding: 10px 16px; border-radius: 12px; font-size: 15px; line-height: 1.5;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05); position: relative; word-wrap: break-word; min-width: 60px;
        }
        .msg-row.sent .bubble { background: var(--msg-sent); border-bottom-right-radius: 2px; }
        .msg-row.received .bubble { background: var(--msg-received); border-bottom-left-radius: 2px; }
        .bubble.recalled { background: rgba(0,0,0,0.03); color: #999; font-style: italic; font-size: 13px; box-shadow: none; padding: 6px 12px; }
        
        .voice-player { display: flex; align-items: center; gap: 10px; width: 200px; height: 34px; cursor: pointer; max-width: 50vw; min-width: 140px; }
        .v-btn { font-size: 22px; display: flex; color: var(--btn-primary); }
        .v-track { flex: 1; height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; }
        .v-prog { height: 100%; background: var(--btn-primary); width: 0%; transition: width 0.1s linear; }
        .v-time { font-size: 12px; opacity: 0.6; font-family: sans-serif; min-width: 24px; text-align: right; }
        .msg-img { max-width: 100%; border-radius: 8px; cursor: zoom-in; display: block; }
        .file-content { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.04); padding: 8px 12px; border-radius: 8px; text-decoration: none; color: var(--text-main); font-size: 13px; }
        
        .msg-meta { display: flex; align-items: center; gap: 4px; margin-top: 4px; font-size: 10px; opacity: 0.5; font-family: sans-serif; }
        /* å·²è¯»å›æ‰§å›¾æ ‡ */
        .read-icon { font-size: 14px; line-height: 1; color: #aaa; transition: color 0.3s; }
        .read-icon.read { color: var(--blue-read); }

        /* Footer */
        .chat-footer {
            padding: 10px 15px; background: #fff; border-top: 1px solid var(--border);
            display: flex; align-items: flex-end; gap: 10px; min-height: 64px;
        }
        .tool-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: transparent; color: var(--text-light); font-size: 20px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .tool-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .tool-btn.recording { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .input-wrapper { flex: 1; background: #fdfdfd; border: 1px solid var(--border); border-radius: 20px; padding: 8px 12px; min-height: 40px; display: flex; align-items: center; }
        .msg-input { width: 100%; border: none; background: transparent; outline: none; font-size: 15px; font-family: inherit; resize: none; max-height: 100px; line-height: 20px; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--btn-primary); color: #fff; border: none; font-size: 18px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.2s; margin-bottom: 2px; }
        .send-btn:active { transform: scale(0.9); }

        /* å½•éŸ³ç¡®è®¤ */
        .record-confirm { flex: 1; display: flex; align-items: center; justify-content: space-between; background: #fff; border-radius: 20px; padding: 0 15px; height: 40px; border: 1px solid var(--border); }
        .record-bar { flex: 1; display: flex; align-items: center; justify-content: center; background: #fff0f0; border-radius: 20px; height: 40px; color: #e74c3c; font-weight: bold; font-size: 14px; cursor: pointer; border: 1px solid #ffcccc; user-select: none; }
        .rc-btn { font-size: 24px; padding: 5px; cursor: pointer; }

        /* è¡¨æƒ…é¢æ¿ */
        .emoji-box {
            position: absolute; bottom: 70px; left: 10px; width: 320px; height: 250px;
            background: #fff; border-radius: 12px; box-shadow: var(--shadow-md); border: 1px solid var(--border);
            z-index: 50; display: flex; flex-direction: column; overflow: hidden;
        }
        .emoji-nav { display: flex; border-bottom: 1px solid #eee; background: #fcfcfc; }
        .e-tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; opacity: 0.6; font-size: 18px; }
        .e-tab.active { opacity: 1; border-bottom: 2px solid var(--btn-primary); background: #fff; }
        .emoji-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .e-item { font-size: 26px; cursor: pointer; padding: 5px; text-align: center; color: #000; }
        .e-item:active { background: #f0f0f0; border-radius: 4px; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .main-chat { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                z-index: 20; /* ç›–ä½ Sidebar */
            }
            .main-chat.active { transform: translateX(0); }
            .back-btn { display: block; }
            .emoji-box { width: 96%; left: 2%; bottom: 80px; }
            .message-bubble { font-size: 16px; padding: 10px 14px; }
        }

        /* Modals & Utils */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 36, 27, 0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal { background: #fffbf0; width: 340px; padding: 30px; border-radius: 16px; box-shadow: var(--shadow-md); border: 1px solid var(--border); text-align: center; position: relative; }
        .m-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 15px; background: #fff; }
        .m-btn { width: 100%; padding: 12px; background: var(--btn-primary); color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .ctx-menu { position: fixed; background: #fff; border-radius: 8px; box-shadow: var(--shadow-md); padding: 4px 0; z-index: 200; min-width: 120px; border: 1px solid var(--border); }
        .ctx-item { padding: 12px 16px; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .ctx-item:active { background: var(--bg-paper); } .ctx-item.del { color: var(--danger); }
        .img-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:300; display:flex; justify-content:center; align-items:center; cursor: zoom-out; }
        .img-full { max-width:100%; max-height:100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="app" @click="closePopups">
    <div class="img-modal" v-if="previewUrl" @click="previewImg(null)"><img :src="previewUrl" class="img-full"></div>

    <div class="ctx-menu" v-if="ctxMenu.show" :style="{top:ctxMenu.y+'px', left:ctxMenu.x+'px'}" @click.stop>
        <div class="ctx-item" v-if="canRecall" @click="recallMsg"><i class="bi bi-arrow-counterclockwise"></i> æ’¤å›</div>
        <div class="ctx-item del" @click="deleteMsg"><i class="bi bi-trash"></i> åˆ é™¤</div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-mask" v-if="!currentUser">
        <div class="modal">
            <h2 style="margin-bottom: 20px;">11s Chat</h2>
            <input type="text" class="m-input" v-model="loginForm.username" placeholder="ç”¨æˆ·å" @keyup.enter="handleLogin">
            <input type="password" class="m-input" v-model="loginForm.password" placeholder="å¯†ç " @keyup.enter="handleLogin">
            <button class="m-btn" @click="handleLogin" :disabled="loading">{{ loading ? 'Loading...' : (isRegistering ? 'æ³¨å†Œ' : 'ç™»å½•') }}</button>
            <div style="margin-top:15px; font-size:13px; color:#888; cursor:pointer;" @click="isRegistering = !isRegistering; errorMsg=''">
                {{ isRegistering ? 'è¿”å›ç™»å½•' : 'åˆ›å»ºæ–°è´¦å·' }}
            </div>
            <div style="color:#e74c3c; font-size:13px; margin-top:10px;">{{ errorMsg }}</div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-mask" v-if="modalType">
        <div class="modal">
            <i class="bi bi-x close-modal" @click="closeModal"></i>
            <h3 style="margin-bottom:15px;">{{ modalTitle }}</h3>
            <template v-if="modalType === 'addFriend'">
                <input type="text" class="m-input" v-model="friendInput" placeholder="è¾“å…¥å¯¹æ–¹ç”¨æˆ·å">
                <button class="m-btn" @click="addFriend" :disabled="loading">æ·»åŠ </button>
            </template>
            <template v-if="modalType === 'editProfile'">
                <input type="text" class="m-input" v-model="profileForm.username" placeholder="æ–°ç”¨æˆ·å">
                <input type="password" class="m-input" v-model="profileForm.password" placeholder="æ–°å¯†ç  (ç•™ç©ºä¸æ”¹)">
                <button class="m-btn" @click="updateProfile" :disabled="loading">ä¿å­˜</button>
            </template>
            <div style="color:#e74c3c; font-size:13px; margin-top:10px;" v-if="modalError">{{ modalError }}</div>
        </div>
    </div>

    <template v-if="currentUser">
        <div class="sidebar" :class="{ hidden: currentChat && isMobile }">
            <div class="brand"><span><i class="bi bi-feather"></i> 11s Chat</span><div class="conn-dot" :class="{ online: isConnected }"></div></div>
            <div class="section-bar"><span>è”ç³»äºº</span><i class="bi bi-plus-circle icon-btn" @click="openModal('addFriend')"></i></div>
            <div class="friend-list">
                <div v-for="f in friends" :key="f.id" class="friend-item" :class="{active: currentChat?.id===f.id}" @click="openChat(f)">
                    <div class="avatar">{{ f.username.charAt(0) }}</div>
                    <div class="friend-info">
                        <div class="friend-top"><span class="friend-name">{{ f.username }}</span><span class="friend-time" v-if="f.lastMsg">{{ formatTime(f.lastMsg.created_at, true) }}</span></div>
                        <div class="friend-top"><span class="friend-msg">{{ getPreview(f.lastMsg) }}</span><div class="unread-dot" v-if="f.unread > 0">{{ f.unread }}</div></div>
                    </div>
                </div>
                <div v-if="friends.length===0" style="text-align:center; padding:30px; font-size:13px; color:#999;">æš‚æ— å¥½å‹</div>
            </div>
            <div class="user-footer">
                <div style="display:flex; align-items:center; gap:10px;"><div class="avatar" style="width:32px; height:32px; font-size:14px; background:var(--text-main);">{{ currentUser.username.charAt(0) }}</div><span class="user-name">{{ currentUser.username }}</span></div>
                <div style="display:flex; gap:10px; font-size:18px; color:var(--text-light);"><i class="bi bi-gear-fill icon-btn" @click="openModal('editProfile')"></i><i class="bi bi-box-arrow-right icon-btn" @click="logout"></i></div>
            </div>
        </div>

        <div class="main-chat" :class="{ active: currentChat }">
            <template v-if="currentChat">
                <div class="chat-header"><i class="bi bi-chevron-left back-btn" @click="closeChat"></i><span>{{ currentChat.username }}</span></div>
                <div class="chat-area" id="msg-box" @scroll="onScroll" @click="showEmoji=false">
                    <TransitionGroup name="msg-anim">
                        <div v-for="msg in messages" :key="msg.id" class="msg-row" :class="msg.sender_id === currentUser.id ? 'sent' : 'received'">
                            <div class="bubble" :class="{ recalled: msg.is_recalled }" @contextmenu.prevent="openCtxMenu($event, msg)" @click="handleMobileCtx($event, msg)">
                                <div v-if="msg.is_recalled"><i class="bi bi-arrow-counterclockwise"></i> æ’¤å›</div>
                                <template v-else>
                                    <div v-if="msg.msg_type === 'text'">{{ msg.content }}</div>
                                    <img v-else-if="msg.msg_type === 'image'" :src="msg.file_url" class="img-content" @click.stop="previewImg(msg.file_url)">
                                    <a v-else-if="msg.msg_type === 'file'" :href="msg.file_url" target="_blank" class="file-content"><i class="bi bi-file-earmark"></i> {{ msg.file_name || 'æ–‡ä»¶' }}</a>
                                    <div v-else-if="msg.msg_type === 'voice'" class="voice-player" @click.stop="toggleVoice(msg)">
                                        <div class="v-btn"><i class="bi" :class="playingId === msg.id ? 'bi-pause-fill' : 'bi-play-fill'"></i></div>
                                        <div class="v-track"><div class="v-prog" :style="{width: (playingId === msg.id ? playProgress : 0) + '%'}"></div></div>
                                        <div class="v-time">{{ msg.file_name?.replace(/[^\d]/g, '') || '' }}s</div>
                                    </div>
                                </template>
                            </div>
                            <div class="msg-meta" v-if="!msg.is_recalled">
                                <span v-if="msg.sender_id === currentUser.id" class="read-icon" :class="{ read: msg.is_read }"><i class="bi" :class="msg.is_read ? 'bi-check2-all' : 'bi-check2'"></i></span>
                                <span>{{ formatTime(msg.created_at) }}</span>
                            </div>
                        </div>
                    </TransitionGroup>
                </div>
                <div class="chat-footer">
                    <template v-if="voiceBlob">
                        <div class="record-confirm">
                            <span style="font-size:13px; color:#555;">è¯­éŸ³å¾…å‘é€</span>
                            <div style="display:flex; gap:15px;">
                                <i class="bi bi-play-circle-fill rc-btn" style="color:var(--text-main);" @click="playDraftVoice"></i>
                                <i class="bi bi-x-circle-fill rc-btn" style="color:var(--danger);" @click="voiceBlob=null"></i>
                                <i class="bi bi-check-circle-fill rc-btn" style="color:var(--success);" @click="uploadVoice"></i>
                            </div>
                        </div>
                    </template>
                    <template v-else-if="isRecording">
                        <div class="record-bar" @mouseup="stopRecord" @touchend="stopRecord"><i class="bi bi-mic-fill"></i> æ¾å¼€ç»“æŸå½•éŸ³</div>
                    </template>
                    <template v-else>
                        <button class="tool-btn" @click="triggerFile"><i class="bi bi-paperclip"></i></button>
                        <input type="file" id="fileInput" hidden @change="handleFile">
                        <button class="tool-btn" @mousedown="startRecord" @touchstart.prevent="startRecord"><i class="bi bi-mic"></i></button>
                        <div class="input-wrapper">
                            <input type="text" class="msg-input" v-model="newMessage" placeholder="å†™ä¿¡..." @keyup.enter="sendText" @focus="markRead">
                            <button class="tool-btn" @click.stop="showEmoji = !showEmoji"><i class="bi bi-emoji-smile"></i></button>
                        </div>
                        <button class="send-btn" @click="sendText" v-if="newMessage.trim()"><i class="bi bi-arrow-up"></i></button>
                    </template>
                    <div class="emoji-box" v-if="showEmoji" @click.stop>
                        <div class="emoji-nav"><div class="e-tab" :class="{active: emojiTab===i}" v-for="(cat,i) in ['ğŸ˜€','ğŸ»','ğŸ','âš½']" @click="emojiTab=i">{{cat}}</div></div>
                        <div class="emoji-grid"><div class="e-item" v-for="e in currentEmojis" @click="addEmoji(e)">{{e}}</div></div>
                    </div>
                </div>
            </template>
            <template v-else>
                <div class="empty-state" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; opacity:0.3;"><i class="bi bi-chat-dots" style="font-size:48px; margin-bottom:10px;"></i><div>é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©</div></div>
            </template>
        </div>
    </template>
</div>

<script>
const SUPABASE_URL = 'https://fznfneqwxzuwtognuoeo.supabase.co';
const SUPABASE_KEY = 'sb_publishable_UlNMDLt4OaYIX-_lCezGwA_8jIQLhFO';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const { createApp, ref, onMounted, nextTick, onUnmounted, computed } = Vue;
const EMOJIS = [['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'],['ğŸµ','ğŸ’','ğŸ¦','ğŸ¦§','ğŸ¶','ğŸ•','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸ©','ğŸº','ğŸ¦Š','ğŸ¦','ğŸ±','ğŸˆ','ğŸˆâ€â¬›','ğŸ¦','ğŸ¯','ğŸ…','ğŸ†','ğŸ´','ğŸ','ğŸ¦„','ğŸ¦“','ğŸ¦Œ','ğŸ®','ox','ğŸƒ','ğŸ„','ğŸ·','ğŸ–','ğŸ—','ğŸ½','ğŸ','ğŸ‘','ğŸ','ğŸª','ğŸ«','ğŸ¦™','ğŸ¦™','ğŸ¦’','ğŸ˜','ğŸ¦£','ğŸ¦','ğŸ¦›','ğŸ­','ğŸ','ğŸ€','ğŸ¹','ğŸ°','ğŸ‡','ğŸ¿ï¸','ğŸ¦«','ğŸ¦”','ğŸ¦”','ğŸ¦‡','ğŸ»','ğŸ»â€â„ï¸','ğŸ¨','ğŸ¼','ğŸ¦¥','ğŸ¦¦','ğŸ¦¦','ğŸ¦¨','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ§','ğŸ•Šï¸','ğŸ¦…','ğŸ¦†','ğŸ¦¢','ğŸ¦‰','ğŸ¦¤','ğŸ¦©','ğŸ¦š','ğŸ¦œ','ğŸ¦œ','ğŸ¸','ğŸŠ','ğŸ¢','ğŸ¦','ğŸ','ğŸ²','ğŸ‰','ğŸ¦•','ğŸ¦–','ğŸ³','ğŸ‹','ğŸ¬','ğŸŸ','ğŸ ','ğŸ¡','ğŸ¦ˆ','ğŸ™','ğŸš','ğŸŒ','ğŸ¦‹','ğŸ›','ğŸœ','ğŸ','ğŸª²','ğŸ','ğŸ¦—','ğŸ•·ï¸','ğŸ•¸ï¸','ğŸ¦‚','ğŸ¦Ÿ','ğŸª°','ğŸª±','ğŸ¦ '],['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶ï¸','ğŸ«‘','ğŸŒ½','ğŸ¥•','ğŸ«’','ğŸ§„','ğŸ§…','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸ«–','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§‹','ğŸ§ƒ','ğŸ§‰','ğŸ§Š','ğŸ¥¢','ğŸ½ï¸','ğŸ´','ğŸ¥„'],['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ¸','ğŸ’','ğŸ‘','â›³','â›³','ğŸ¹','ğŸ¥…','ğŸ¥…','ğŸ¥Š','ğŸ¥‹','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¥Œ','ğŸ¿','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ‹ï¸â€â™‚ï¸','ğŸ‹ï¸â€â™€ï¸','ğŸ¤¼','ğŸ¤¼â€â™‚ï¸','ğŸ¤¼â€â™€ï¸','ğŸ¤¸','ğŸ¤¸â€â™‚ï¸','ğŸ¤¸â€â™€ï¸','â›¹ï¸','â›¹ï¸â€â™‚ï¸','â›¹ï¸â€â™€ï¸','ğŸ¤º','ğŸ¤¾','ğŸ¤¾â€â™‚ï¸','ğŸ¤¾â€â™€ï¸','ğŸŒï¸','ğŸŒï¸â€â™‚ï¸','ğŸŒï¸â€â™€ï¸','ğŸ‡','ğŸ§˜','ğŸ§˜â€â™‚ï¸','ğŸ§˜â€â™€ï¸','ğŸ„','ğŸ„â€â™‚ï¸','ğŸ„â€â™€ï¸','ğŸŠ','ğŸŠâ€â™‚ï¸','ğŸŠâ€â™€ï¸','ğŸ¤½','ğŸ¤½â€â™‚ï¸','ğŸ¤½â€â™€ï¸','ğŸš£','ğŸš£â€â™‚ï¸','ğŸš£â€â™€ï¸','ğŸ§—','ğŸ§—â€â™‚ï¸','ğŸ§—â€â™€ï¸','ğŸšµ','ğŸšµâ€â™‚ï¸','ğŸšµâ€â™€ï¸','ğŸš´','ğŸš´â€â™‚ï¸','ğŸš´â€â™€ï¸','ğŸ†','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸ«','ğŸŸï¸','ğŸª','ğŸ¤¹','ğŸ¤¹â€â™‚ï¸','ğŸ¤¹â€â™€ï¸','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸ·','ğŸº','ğŸ¸','ğŸª•','ğŸ»','ğŸ²','ğŸ§©','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸª€','ğŸª','ğŸ®','ğŸ‘¾','ğŸ°','ğŸ°']];

createApp({
    setup() {
        const currentUser = ref(null);
        const loginForm = ref({ username: '', password: '' });
        const isRegistering = ref(false);
        const loading = ref(false);
        const errorMsg = ref('');
        
        const modalType = ref(null);
        const modalError = ref('');
        const modalTitle = ref('');
        const friendInput = ref('');
        const profileForm = ref({ username: '', password: '' });

        const friends = ref([]);
        const currentChat = ref(null);
        const messages = ref([]);
        const newMessage = ref('');
        const isConnected = ref(false);
        const isMobile = ref(window.innerWidth <= 768);
        
        const showEmoji = ref(false);
        const emojiTab = ref(0);
        const previewUrl = ref(null);
        const ctxMenu = ref({ show: false, x: 0, y: 0, msg: null });
        
        const isRecording = ref(false);
        const voiceBlob = ref(null);
        const playingId = ref(null);
        const playProgress = ref(0);
        let mediaRecorder = null;
        let audioChunks = [];
        let currentAudio = null;
        let progInterval = null;
        let pollingInterval = null;

        const currentEmojis = computed(() => EMOJIS[emojiTab.value]);
        const canRecall = computed(() => {
            if(!ctxMenu.value.msg) return false;
            return (new Date() - new Date(ctxMenu.value.msg.created_at)) / 1000 / 60 < 2;
        });

        onMounted(() => {
            const saved = localStorage.getItem('11s_user');
            if(saved) { try { currentUser.value = JSON.parse(saved); initSystem(); } catch(e){} }
            window.addEventListener('resize', () => isMobile.value = window.innerWidth <= 768);
        });

        onUnmounted(() => { if(pollingInterval) clearInterval(pollingInterval); stopAudio(); });

        const handleLogin = async () => {
            errorMsg.value = '';
            if(!loginForm.value.username) return;
            loading.value = true;
            const u = loginForm.value.username.trim(), p = loginForm.value.password;
            try {
                if(isRegistering.value) {
                    const {data:e} = await sb.from('chat_users').select('id').eq('username', u).maybeSingle();
                    if(e) throw new Error("ç”¨æˆ·å·²å­˜åœ¨");
                    const {data:n, error} = await sb.from('chat_users').insert({username:u, password:p}).select().single();
                    if(error) throw error;
                    loginOk(n);
                } else {
                    const {data:user, error} = await sb.from('chat_users').select('*').eq('username', u).maybeSingle();
                    if(error || !user || user.password !== p) throw new Error("å¤±è´¥");
                    loginOk(user);
                }
            } catch(e) { errorMsg.value = e.message; }
            loading.value = false;
        };
        const loginOk = (u) => { currentUser.value = u; localStorage.setItem('11s_user', JSON.stringify(u)); loginForm.value={username:'',password:''}; initSystem(); };
        const logout = () => { localStorage.removeItem('11s_user'); location.reload(); };
        const initSystem = () => { loadFriends(); setupRealtime(); startPolling(); };

        const loadFriends = async () => {
            if(!currentUser.value) return;
            const { data: f1 } = await sb.from('chat_friends').select('friend_id').eq('user_id', currentUser.value.id);
            const { data: f2 } = await sb.from('chat_friends').select('user_id').eq('friend_id', currentUser.value.id);
            const ids = [...new Set([...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)])];
            if(ids.length > 0) {
                const { data: users } = await sb.from('chat_users').select('*').in('id', ids);
                const list = await Promise.all(users.map(async u => {
                    const { data: msgs } = await sb.from('chat_messages').select('*').or(`sender_id.eq.${u.id},receiver_id.eq.${u.id}`).or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`).order('created_at', { ascending: false }).limit(1);
                    const { count } = await sb.from('chat_messages').select('*', { count: 'exact', head: true }).eq('sender_id', u.id).eq('receiver_id', currentUser.value.id).eq('is_read', false);
                    return { ...u, unread: count || 0, lastMsg: msgs?.[0] };
                }));
                friends.value = list.sort((a,b) => new Date(b.lastMsg?.created_at||0) - new Date(a.lastMsg?.created_at||0));
            }
        };

        const openChat = async (friend) => {
            currentChat.value = friend;
            friend.unread = 0;
            await loadMessages();
            markRead();
            if(isMobile.value) nextTick(() => document.querySelector('.main-chat').classList.add('active'));
        };

        const closeChat = () => { document.querySelector('.main-chat').classList.remove('active'); setTimeout(() => currentChat.value = null, 300); };
        
        const loadMessages = async () => {
            if(!currentChat.value) return;
            const { data } = await sb.from('chat_messages').select('*').or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`).order('created_at', { ascending: true });
            messages.value = (data||[]).filter(m => (m.sender_id===currentUser.value.id && m.receiver_id===currentChat.value.id) || (m.sender_id===currentChat.value.id && m.receiver_id===currentUser.value.id));
            scrollToBottom();
        };

        const sendText = async () => {
            if(!newMessage.value.trim()) return;
            const content = newMessage.value; newMessage.value = ''; showEmoji.value = false;
            // Optimistic
            const tmp = { id: Date.now(), sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content, msg_type: 'text', created_at: new Date().toISOString(), is_read: false };
            messages.value.push(tmp); scrollToBottom();
            await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content, msg_type: 'text' });
        };

        const startPolling = () => {
            if(pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(() => { if(currentChat.value) loadMessages(); loadFriends(); }, 3000);
        };
        const markRead = async () => { if(currentChat.value) await sb.from('chat_messages').update({is_read:true}).eq('sender_id',currentChat.value.id).eq('receiver_id',currentUser.value.id).eq('is_read',false); };

        const startRecord = async () => {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(s);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => voiceBlob.value = new Blob(audioChunks, {type:'audio/webm'});
                mediaRecorder.start(); isRecording.value = true;
            } catch(e) { alert("éº¦å…‹é£æƒé™æ‹’ç»"); }
        };
        const stopRecord = () => { if(mediaRecorder?.state !== 'inactive') { mediaRecorder.stop(); isRecording.value = false; } };
        const playDraftVoice = () => new Audio(URL.createObjectURL(voiceBlob.value)).play();
        const uploadVoice = async () => {
            if(!voiceBlob.value) return;
            const duration = Math.max(1, Math.ceil(voiceBlob.value.size / 5000));
            const name = `voice_${Date.now()}.webm`;
            // Optimistic
            const tmp = { id: Date.now(), sender_id: currentUser.value.id, receiver_id: currentChat.value.id, msg_type: 'voice', file_name: duration+'s', created_at: new Date().toISOString(), is_read: false };
            messages.value.push(tmp); scrollToBottom(); voiceBlob.value = null;
            try {
                await sb.storage.from('chat-uploads').upload(name, voiceBlob.value);
                const { data } = sb.storage.from('chat-uploads').getPublicUrl(name);
                await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, msg_type: 'voice', file_url: data.publicUrl, file_name: duration+'s', content: '[è¯­éŸ³]' });
            } catch(e) { console.error(e); }
        };
        const toggleVoice = (msg) => {
            if(playingId.value === msg.id) { stopAudio(); return; }
            stopAudio();
            const audio = new Audio(msg.file_url);
            currentAudio = audio; playingId.value = msg.id;
            audio.play();
            progInterval = setInterval(() => { if(audio.duration) playProgress.value = (audio.currentTime/audio.duration)*100; }, 100);
            audio.onended = stopAudio;
        };
        const stopAudio = () => { if(currentAudio) { currentAudio.pause(); currentAudio=null; } clearInterval(progInterval); playingId.value=null; playProgress.value=0; };

        const triggerFile = () => document.getElementById('fileInput').click();
        const handleFile = async (e) => {
            const file = e.target.files[0]; if(!file) return;
            const type = file.type.startsWith('image') ? 'image' : 'file';
            const name = `${Date.now()}_${file.name}`;
            try {
                const { error } = await sb.storage.from('chat-uploads').upload(name, file);
                if(error) throw error;
                const { data } = sb.storage.from('chat-uploads').getPublicUrl(name);
                await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, msg_type: type, file_url: data.publicUrl, file_name: file.name, content: type==='image'?'[å›¾ç‰‡]':'[æ–‡ä»¶]' });
            } catch(e) { alert("ä¸Šä¼ å¤±è´¥"); }
        };

        const setupRealtime = () => {
            sb.removeAllChannels();
            sb.channel('public:chat_messages').on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, p => {
                const msg = p.new;
                if(p.eventType === 'INSERT') {
                    if(currentChat.value && (msg.sender_id === currentChat.value.id || msg.sender_id === currentUser.value.id)) {
                        if(!messages.value.some(m => m.id === msg.id)) { messages.value.push(msg); scrollToBottom(); }
                        if(msg.sender_id === currentChat.value.id) markRead();
                    }
                    loadFriends();
                } else if(p.eventType === 'UPDATE') {
                    const i = messages.value.findIndex(m => m.id === msg.id);
                    if(i !== -1) messages.value[i] = msg;
                }
            }).subscribe(s => isConnected.value = s === 'SUBSCRIBED');
        };

        // --- Utils ---
        const openModal = (t) => { modalType.value = t; modalError.value = ''; friendInput.value=''; if(t==='addFriend') modalTitle.value='æ·»åŠ å¥½å‹'; else modalTitle.value='ä¿®æ”¹èµ„æ–™'; };
        const closeModal = () => modalType.value = null;
        const addFriend = async () => {
            loading.value = true;
            try {
                const { data:t } = await sb.from('chat_users').select('*').eq('username', friendInput.value.trim()).maybeSingle();
                if(!t) throw new Error("ç”¨æˆ·ä¸å­˜åœ¨");
                if(t.id === currentUser.value.id) throw new Error("ä¸èƒ½åŠ è‡ªå·±");
                await sb.from('chat_friends').insert({user_id:currentUser.value.id, friend_id:t.id});
                alert("æ·»åŠ æˆåŠŸ"); closeModal(); loadFriends();
            } catch(e) { modalError.value = e.message; }
            loading.value = false;
        };
        const updateProfile = async () => {
            const u = profileForm.value.username.trim(), p = profileForm.value.password;
            if(!u) return; loading.value = true;
            try {
                const up = { username: u }; if(p) up.password = p;
                await sb.from('chat_users').update(up).eq('id', currentUser.value.id);
                currentUser.value = {...currentUser.value, ...up};
                localStorage.setItem('11s_user', JSON.stringify(currentUser.value));
                alert("ä¿®æ”¹æˆåŠŸ"); closeModal();
            } catch(e) { modalError.value = "å¤±è´¥"; }
            loading.value = false;
        };
        const addEmoji = (e) => newMessage.value += e;
        const handleClickOutside = () => { showEmoji.value = false; ctxMenu.value.show = false; };
        const openCtxMenu = (e, msg) => { if(msg.sender_id===currentUser.value.id && !msg.is_recalled) { ctxMenu.value={show:true, x:e.clientX, y:e.clientY, msg}; } };
        const handleMobileCtx = (e, msg) => { if(isMobile.value && msg.sender_id===currentUser.value.id) { e.preventDefault(); openCtxMenu(e, msg); } };
        const recallMsg = async () => { await sb.from('chat_messages').update({is_recalled:true}).eq('id', ctxMenu.value.msg.id); ctxMenu.value.show = false; };
        const deleteMsg = () => { messages.value = messages.value.filter(m => m.id !== ctxMenu.value.msg.id); ctxMenu.value.show = false; };
        const scrollToBottom = () => nextTick(() => { const c = document.getElementById('msg-box'); if(c) c.scrollTop = c.scrollHeight + 100; });
        const formatTime = (iso, short) => {
            const d = new Date(iso);
            if(short) { const now = new Date(); if(d.toDateString()===now.toDateString()) return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`; return `${d.getMonth()+1}/${d.getDate()}`; }
            return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        };
        const getPreview = (m) => !m ? '' : (m.is_recalled ? 'æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯' : (m.msg_type==='text'?m.content:`[${m.msg_type}]`));

        return {
            currentUser, loginForm, isRegistering, loading, errorMsg, friends, currentChat, messages, newMessage, isConnected,
            isMobile, modalType, modalError, modalTitle, friendInput, profileForm, previewUrl, showEmoji, emojiTab, currentEmojis,
            isRecording, voiceBlob, playingId, playProgress, ctxMenu, canRecall,
            handleLogin, logout, initProfile: ()=>openModal('editProfile'), openModal, closeModal, addFriend, updateProfile,
            openChat, closeChat, sendText, triggerFile, handleFile, startRecord, stopRecord, playDraftVoice, uploadVoice, toggleVoice,
            openCtxMenu, handleMobileCtx, recallMsg, deleteMsg, closePopups: handleClickOutside, previewImg: (u)=>previewUrl.value=u, addEmoji,
            formatTime, getPreview, markRead
        };
    }
}).mount('#app');
</script>
</body>
</html>
