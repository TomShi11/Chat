<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šç¦æ­¢ç¼©æ”¾ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ§å»¶è¿Ÿï¼Œé€‚é…è½¯é”®ç›˜ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>11s Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“œ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-paper: #fdf6e3; --bg-sidebar: #f5eacb; --bg-accent: #d4c5a3;     
            --text-main: #4a3b2a; --text-light: #8b7e74; --border: #dcd3c1;
            --msg-sent: #eaddcf; --msg-received: #ffffff;  
            --btn-primary: #5b4636; --btn-hover: #423226; --radius: 12px;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-paper); color: var(--text-main); 
            font-family: "Georgia", "Songti SC", serif; 
            height: 100vh; height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; 
        }
        
        #app { width: 100%; height: 100%; display: flex; position: relative; }

        /* --- ä¾§è¾¹æ  (å¥½å‹åˆ—è¡¨) --- */
        .sidebar { 
            width: 280px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 24px; z-index: 10; 
            transition: transform 0.3s ease;
        }
        .brand { font-size: 22px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .conn-status { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-left: auto; transition: 0.3s; }
        .conn-status.online { background: #34c759; box-shadow: 0 0 5px #34c759; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--text-light); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .icon-btn { cursor: pointer; transition: 0.2s; font-size: 18px; padding: 5px; } 
        
        .friend-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; -webkit-overflow-scrolling: touch; }
        .friend-item { 
            padding: 12px; border-radius: var(--radius); cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; gap: 12px; border: 1px solid transparent; position: relative; 
        }
        .friend-item:active { background-color: rgba(255,255,255,0.6); }
        .friend-item.active { background-color: #fff; border-color: var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .avatar { width: 42px; height: 42px; background: var(--bg-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; text-transform: uppercase; font-size: 16px; flex-shrink: 0; }
        .friend-info { flex: 1; min-width: 0; }
        .friend-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .friend-preview { font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { background: var(--danger); color: white; font-size: 10px; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 5px; font-weight: bold; }

        .user-panel { margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 12px; }
        .user-actions { margin-left: auto; display: flex; gap: 15px; }
        .action-icon { font-size: 20px; cursor: pointer; color: var(--text-light); padding: 5px; }

        /* --- èŠå¤©ä¸»çª—å£ --- */
        .main-chat { 
            flex: 1; display: flex; flex-direction: column; 
            background-image: radial-gradient(#dccdb3 1px, transparent 1px); background-size: 24px 24px; 
            position: relative; z-index: 5;
        }
        .chat-header { 
            padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 18px; font-weight: bold; 
            background: rgba(253, 246, 227, 0.95); backdrop-filter: blur(10px); 
            display: flex; align-items: center; gap: 15px; z-index: 20; height: 60px;
        }
        .back-btn { display: none; font-size: 24px; cursor: pointer; padding-right: 10px; }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        .message-row { display: flex; flex-direction: column; max-width: 85%; position: relative; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .message-row.sent { align-self: flex-end; align-items: flex-end; }
        .message-row.received { align-self: flex-start; align-items: flex-start; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .message-bubble { padding: 10px 14px; border-radius: 16px; font-size: 16px; line-height: 1.5; box-shadow: 2px 2px 6px rgba(0,0,0,0.03); word-wrap: break-word; position: relative; cursor: context-menu; min-width: 60px; }
        .message-bubble.sent { background-color: var(--msg-sent); border-bottom-right-radius: 2px; }
        .message-bubble.received { background-color: var(--msg-received); border-bottom-left-radius: 2px; }
        .message-bubble.recalled { background: rgba(0,0,0,0.05); color: #999; font-style: italic; font-size: 13px; padding: 8px 12px; box-shadow: none; }

        .voice-player { display: flex; align-items: center; gap: 12px; width: 180px; height: 36px; cursor: pointer; }
        .voice-btn { font-size: 24px; color: var(--text-main); display: flex; align-items: center; justify-content: center; }
        .voice-track { flex: 1; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; position: relative; overflow: hidden; }
        .voice-progress { height: 100%; background: var(--text-main); width: 0%; transition: width 0.1s linear; }
        .voice-duration { font-size: 12px; color: var(--text-light); min-width: 30px; text-align: right; }

        .msg-img { max-width: 100%; border-radius: 8px; cursor: zoom-in; display: block; }
        .msg-file { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.05); padding: 8px 12px; border-radius: 8px; text-decoration: none; color: var(--text-main); font-size: 14px; }
        .msg-meta { font-size: 10px; opacity: 0.5; margin-top: 4px; display: flex; gap: 6px; align-items: center; }
        .read-status { font-weight: bold; color: var(--btn-primary); }

        /* è¾“å…¥åŒº */
        .chat-input-area { 
            padding: 10px 15px; border-top: 1px solid var(--border); background: rgba(253, 246, 227, 0.95); 
            display: flex; gap: 8px; align-items: flex-end; min-height: 60px;
        }
        .toolbar-btn { background: transparent; border: none; color: var(--text-light); font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
        .toolbar-btn:active { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .toolbar-btn.recording { color: var(--danger); animation: pulse 1s infinite; background: rgba(239, 68, 68, 0.1); }
        
        .input-box { flex: 1; border: 1px solid var(--border); background: #fff; padding: 10px 14px; border-radius: 20px; font-size: 16px; outline: none; resize: none; height: 44px; line-height: 22px; max-height: 100px; margin-bottom: 8px; }
        .input-box:focus { border-color: var(--text-light); }
        .send-btn { background: var(--btn-primary); color: #fff; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; margin-bottom: 8px; }
        
        /* è¡¨æƒ…é¢æ¿ - ç§»åŠ¨ç«¯é€‚é… */
        .emoji-panel { 
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); 
            background: #fff; border: 1px solid var(--border); border-radius: 12px; 
            width: 90%; max-width: 320px; height: 250px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; display: flex; flex-direction: column; 
        }
        .emoji-tabs { display: flex; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .emoji-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 18px; opacity: 0.6; }
        .emoji-tab.active { opacity: 1; background: #fff; font-weight: bold; border-bottom: 2px solid var(--btn-primary); }
        .emoji-content { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; border-radius: 4px; padding: 5px; }

        /* å³é”®èœå• */
        .context-menu { position: fixed; background: #fff; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 5px 0; z-index: 1000; min-width: 140px; }
        .menu-item { padding: 12px 16px; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        .menu-item:active { background: var(--bg-paper); }
        .menu-item.danger { color: var(--danger); }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 59, 42, 0.4); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-card { background: #fffbf0; padding: 30px; width: 90%; max-width: 360px; border-radius: 16px; box-shadow: 0 20px 40px rgba(91, 70, 54, 0.2); text-align: center; border: 1px solid var(--border); position: relative; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--text-main); }
        .modal-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; outline: none; background: #fff; }
        .modal-btn { width: 100%; margin-top: 10px; padding: 14px; background: var(--btn-primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .modal-btn.secondary { background: transparent; color: var(--text-light); margin-top: 5px; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; padding: 5px; cursor: pointer; color: var(--text-light); }

        .img-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .img-preview { max-width: 100%; max-height: 100%; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; opacity: 0.4; }

        /* ğŸ“± ç§»åŠ¨ç«¯é€‚é…æ ¸å¿ƒä»£ç  */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .main-chat { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                transform: translateX(100%); transition: transform 0.3s ease; 
                z-index: 50; background-color: var(--bg-paper);
            }
            .main-chat.active { transform: translateX(0); } /* æ¿€æ´»æ—¶æ»‘å…¥ */
            
            .back-btn { display: block; } /* æ˜¾ç¤ºè¿”å›æŒ‰é’® */
            
            /* éšè—ä¾§è¾¹æ å½“èŠå¤©æ‰“å¼€æ—¶ (è™½ç„¶è¢«è¦†ç›–äº†ï¼Œä½†ä¸ºäº†æ€§èƒ½) */
            .sidebar.chat-open { opacity: 0; pointer-events: none; }
            
            .modal-card { padding: 25px 20px; }
            .message-bubble { max-width: 80%; }
        }
    </style>
</head>
<body>

<div id="app" @click="handleClickOutside">
    <!-- å¤§å›¾é¢„è§ˆ -->
    <div class="img-preview-overlay" v-if="previewImg" @click="previewImg = null">
        <img :src="previewImg" class="img-preview">
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" v-if="contextMenu.visible" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" @click.stop>
        <div class="menu-item" v-if="canRecall" @click="recallMessage"><i class="bi bi-arrow-counterclockwise"></i> æ’¤å›</div>
        <div class="menu-item danger" @click="deleteMessage"><i class="bi bi-trash"></i> åˆ é™¤</div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œ -->
    <div class="modal-overlay" v-if="!currentUser">
        <div class="modal-card">
            <div class="modal-title">11s Chat</div>
            <input type="text" class="modal-input" v-model="loginForm.username" placeholder="ç”¨æˆ·å" @keyup.enter="handleLogin">
            <input type="password" class="modal-input" v-model="loginForm.password" placeholder="å¯†ç " @keyup.enter="handleLogin">
            <button class="modal-btn" @click="handleLogin" :disabled="isLoading">{{ isLoading ? 'å¤„ç†ä¸­...' : (isRegistering ? 'æ³¨å†Œ' : 'ç™»å½•') }}</button>
            <div style="color:red; font-size:12px; margin-top:10px;">{{ errorMessage }}</div>
            <button class="modal-btn secondary" @click="isRegistering = !isRegistering">
                {{ isRegistering ? 'è¿”å›ç™»å½•' : 'åˆ›å»ºæ–°è´¦å·' }}
            </button>
        </div>
    </div>

    <!-- åŠŸèƒ½å¼¹çª— -->
    <div class="modal-overlay" v-if="modalType">
        <div class="modal-card">
            <i class="bi bi-x close-modal" @click="closeModal"></i>
            <div class="modal-title">{{ modalTitle }}</div>
            <template v-if="modalType === 'addFriend'">
                <input type="text" class="modal-input" v-model="friendNameInput" placeholder="è¾“å…¥å¯¹æ–¹ç”¨æˆ·å...">
                <button class="modal-btn" @click="addFriend" :disabled="isLoading">å‘é€é‚€è¯·</button>
            </template>
            <template v-if="modalType === 'editProfile'">
                <input type="text" class="modal-input" v-model="profileForm.newUsername" placeholder="æ–°ç”¨æˆ·å">
                <input type="password" class="modal-input" v-model="profileForm.newPassword" placeholder="æ–°å¯†ç  (ç•™ç©ºä¸æ”¹)">
                <button class="modal-btn" @click="updateProfile" :disabled="isLoading">ä¿å­˜ä¿®æ”¹</button>
            </template>
            <div style="color:red; font-size:12px; margin-top:10px;" v-if="modalError">{{ modalError }}</div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <template v-if="currentUser">
        <!-- ä¾§è¾¹æ  (ç§»åŠ¨ç«¯: currentChat å­˜åœ¨æ—¶éšè—) -->
        <div class="sidebar" :class="{ 'chat-open': currentChat }">
            <div class="brand">
                <span><i class="bi bi-feather"></i> 11s Chat</span>
                <span class="conn-status" :class="{ online: isConnected }" :title="isConnected?'å·²è¿æ¥':'é‡è¿ä¸­...'"></span>
            </div>
            
            <div class="section-header">
                <span>è”ç³»äºº</span>
                <i class="bi bi-plus-circle-fill icon-btn" @click="openModal('addFriend')" title="æ·»åŠ å¥½å‹"></i>
            </div>
            
            <div class="friend-list">
                <div v-for="friend in friends" :key="friend.id" class="friend-item" :class="{ active: currentChat?.id === friend.id }" @click="selectChat(friend)">
                    <div class="avatar">{{ friend.username.substring(0,1) }}</div>
                    <div class="friend-info">
                        <div class="friend-name">{{ friend.username }}</div>
                        <div class="friend-preview">{{ getPreviewText(friend.lastMsg) }}</div>
                    </div>
                    <div class="unread-badge" v-if="friend.unread > 0">{{ friend.unread }}</div>
                </div>
                <div v-if="friends.length === 0" style="text-align:center; padding:20px; font-size:12px; opacity:0.5;">æš‚æ— å¥½å‹</div>
            </div>
            
            <div class="user-panel">
                <div class="avatar" style="background:var(--text-main); width:36px; height:36px; font-size:15px;">{{ currentUser.username.substring(0,1) }}</div>
                <div style="font-weight:bold; font-size:15px;">{{ currentUser.username }}</div>
                <div class="user-actions">
                    <i class="bi bi-gear-fill action-icon" @click="openModal('editProfile')"></i>
                    <i class="bi bi-box-arrow-right action-icon" @click="logout"></i>
                </div>
            </div>
        </div>

        <!-- èŠå¤©åŒº (ç§»åŠ¨ç«¯: å¢åŠ  active ç±»æ»‘å…¥) -->
        <div class="main-chat" :class="{ active: currentChat }">
            <template v-if="currentChat">
                <div class="chat-header">
                    <!-- ç§»åŠ¨ç«¯è¿”å›æŒ‰é’® -->
                    <i class="bi bi-chevron-left back-btn" @click="backToFriends"></i>
                    <span>{{ currentChat.username }}</span>
                </div>
                
                <div class="chat-messages" id="msg-container" @click="showEmoji = false">
                    <div v-for="msg in messages" :key="msg.id" class="message-row" :class="msg.sender_id === currentUser.id ? 'sent' : 'received'">
                        <div class="message-bubble" 
                             :class="[msg.sender_id === currentUser.id ? 'sent' : 'received', { recalled: msg.is_recalled }]"
                             @contextmenu.prevent="showContextMenu($event, msg)"
                             @click="handleMsgClick($event, msg)"> <!-- ç§»åŠ¨ç«¯ç‚¹å‡»æ¨¡æ‹Ÿå³é”® -->
                            
                            <template v-if="msg.is_recalled">
                                <i class="bi bi-arrow-counterclockwise"></i> æ¶ˆæ¯å·²æ’¤å›
                            </template>
                            
                            <template v-else>
                                <div v-if="msg.msg_type === 'text'">{{ msg.content }}</div>
                                <img v-else-if="msg.msg_type === 'image'" :src="msg.file_url" class="msg-img" @click.stop="previewImg = msg.file_url">
                                <a v-else-if="msg.msg_type === 'file'" :href="msg.file_url" target="_blank" class="msg-file">
                                    <i class="bi bi-file-earmark-text"></i> {{ msg.file_name || 'é™„ä»¶' }}
                                </a>
                                <div v-else-if="msg.msg_type === 'voice'" class="voice-player" :class="{ playing: playingAudioId === msg.id }" @click.stop="toggleVoice(msg)">
                                    <div class="voice-btn"><i class="bi" :class="playingAudioId === msg.id ? 'bi-pause-circle-fill' : 'bi-play-circle-fill'"></i></div>
                                    <div class="voice-track"><div class="voice-progress" :style="{ width: (playingAudioId === msg.id ? playProgress : 0) + '%' }"></div></div>
                                    <div class="voice-duration" v-if="msg.file_name">{{ msg.file_name.replace('voice_', '').split('.')[0] }}s</div>
                                </div>
                            </template>
                        </div>
                        <div class="msg-meta" v-if="!msg.is_recalled">
                            <span v-if="msg.sender_id === currentUser.id && msg.is_read" class="read-status">å·²è¯»</span>
                            <span>{{ formatTime(msg.created_at) }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <button class="toolbar-btn" @click="triggerFileUpload"><i class="bi bi-paperclip"></i></button>
                    <input type="file" id="fileInput" style="display:none" @change="handleFileUpload">

                    <button class="toolbar-btn" :class="{ recording: isRecording }" @mousedown="startRecord" @mouseup="stopRecord" @touchstart.prevent="startRecord" @touchend.prevent="stopRecord">
                        <i class="bi bi-mic"></i>
                    </button>

                    <button class="toolbar-btn" @click.stop="showEmoji = !showEmoji"><i class="bi bi-emoji-smile"></i></button>
                    
                    <div class="emoji-panel" v-if="showEmoji" @click.stop>
                        <div class="emoji-tabs">
                            <div class="emoji-tab" :class="{active: emojiTab===i}" v-for="(cat, i) in ['ğŸ˜€','ğŸ»','ğŸ','âš½']" @click="emojiTab=i">{{cat}}</div>
                        </div>
                        <div class="emoji-content">
                            <div class="emoji-item" v-for="em in currentEmojis" @click="addEmoji(em)">{{ em }}</div>
                        </div>
                    </div>

                    <input type="text" class="input-box" v-model="newMessage" placeholder="å†™ä¿¡..." @keyup.enter="sendMessage" @focus="markAsRead">
                    <button class="send-btn" @click="sendMessage"><i class="bi bi-send-fill"></i></button>
                </div>
            </template>
            <template v-else>
                <!-- ç§»åŠ¨ç«¯éšè—ç©ºçŠ¶æ€ï¼Œé¿å…é‡å  -->
                <div class="empty-state" style="display: none;"><i class="bi bi-chat-square-quote empty-icon"></i><p>é€‰æ‹©ä¸€ä¸ªå¥½å‹</p></div>
                <!-- æ¡Œé¢ç«¯æ˜¾ç¤º -->
                <div class="empty-state d-none d-md-flex"><i class="bi bi-chat-square-quote empty-icon"></i><p>é€‰æ‹©ä¸€ä¸ªå¥½å‹</p></div>
            </template>
        </div>
    </template>
</div>

<script>
    const SUPABASE_URL = 'https://fznfneqwxzuwtognuoeo.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_UlNMDLt4OaYIX-_lCezGwA_8jIQLhFO'; 
    
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp, ref, onMounted, nextTick, onUnmounted, computed } = Vue;

    const EMOJI_CATEGORIES = [
        ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'],
        ['ğŸµ','ğŸ’','ğŸ¦','ğŸ¦§','ğŸ¶','ğŸ•','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸ©','ğŸº','ğŸ¦Š','ğŸ¦','ğŸ±','ğŸˆ','ğŸˆâ€â¬›','ğŸ¦','ğŸ¯','ğŸ…','ğŸ†','ğŸ´','ğŸ','ğŸ¦„','ğŸ¦“','ğŸ¦Œ','ğŸ®','ox','ğŸƒ','ğŸ„','ğŸ·','ğŸ–','ğŸ—','ğŸ½','ğŸ','ğŸ‘','ğŸ','ğŸª','ğŸ«','ğŸ¦™','ğŸ¦™','ğŸ¦’','ğŸ˜','ğŸ¦£','ğŸ¦','ğŸ¦›','ğŸ­','ğŸ','ğŸ€','ğŸ¹','ğŸ°','ğŸ‡','ğŸ¿ï¸','ğŸ¦«','ğŸ¦”','ğŸ¦”','ğŸ¦‡','ğŸ»','ğŸ»â€â„ï¸','ğŸ¨','ğŸ¼','ğŸ¦¥','ğŸ¦¦','ğŸ¦¦','ğŸ¦¨','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ§','ğŸ•Šï¸','ğŸ¦…','ğŸ¦†','ğŸ¦¢','ğŸ¦‰','ğŸ¦¤','ğŸ¦©','ğŸ¦š','ğŸ¦œ','ğŸ¦œ','ğŸ¸','ğŸŠ','ğŸ¢','ğŸ¦','ğŸ','ğŸ²','ğŸ‰','ğŸ¦•','ğŸ¦–','ğŸ³','ğŸ‹','ğŸ¬','ğŸŸ','ğŸ ','ğŸ¡','ğŸ¦ˆ','ğŸ™','ğŸš','ğŸŒ','ğŸ¦‹','ğŸ›','ğŸœ','ğŸ','ğŸª²','ğŸ','ğŸ¦—','ğŸ•·ï¸','ğŸ•¸ï¸','ğŸ¦‚','ğŸ¦Ÿ','ğŸª°','ğŸª±','ğŸ¦ '],
        ['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶ï¸','ğŸ«‘','ğŸŒ½','ğŸ¥•','ğŸ«’','ğŸ§„','ğŸ§…','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸ«–','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§‹','ğŸ§ƒ','ğŸ§‰','ğŸ§Š','ğŸ¥¢','ğŸ½ï¸','ğŸ´','ğŸ¥„'],
        ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ¸','ğŸ’','ğŸ‘','â›³','â›³','ğŸ¹','ğŸ¥…','ğŸ¥…','ğŸ¥Š','ğŸ¥‹','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¥Œ','ğŸ¿','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ‹ï¸â€â™‚ï¸','ğŸ‹ï¸â€â™€ï¸','ğŸ¤¼','ğŸ¤¼â€â™‚ï¸','ğŸ¤¼â€â™€ï¸','ğŸ¤¸','ğŸ¤¸â€â™‚ï¸','ğŸ¤¸â€â™€ï¸','â›¹ï¸','â›¹ï¸â€â™‚ï¸','â›¹ï¸â€â™€ï¸','ğŸ¤º','ğŸ¤¾','ğŸ¤¾â€â™‚ï¸','ğŸ¤¾â€â™€ï¸','ğŸŒï¸','ğŸŒï¸â€â™‚ï¸','ğŸŒï¸â€â™€ï¸','ğŸ‡','ğŸ§˜','ğŸ§˜â€â™‚ï¸','ğŸ§˜â€â™€ï¸','ğŸ„','ğŸ„â€â™‚ï¸','ğŸ„â€â™€ï¸','ğŸŠ','ğŸŠâ€â™‚ï¸','ğŸŠâ€â™€ï¸','ğŸ¤½','ğŸ¤½â€â™‚ï¸','ğŸ¤½â€â™€ï¸','ğŸš£','ğŸš£â€â™‚ï¸','ğŸš£â€â™€ï¸','ğŸ§—','ğŸ§—â€â™‚ï¸','ğŸ§—â€â™€ï¸','ğŸšµ','ğŸšµâ€â™‚ï¸','ğŸšµâ€â™€ï¸','ğŸš´','ğŸš´â€â™‚ï¸','ğŸš´â€â™€ï¸','ğŸ†','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸ«','ğŸŸï¸','ğŸª','ğŸ¤¹','ğŸ¤¹â€â™‚ï¸','ğŸ¤¹â€â™€ï¸','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸ·','ğŸº','ğŸ¸','ğŸª•','ğŸ»','ğŸ²','ğŸ§©','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸª€','ğŸª','ğŸ®','ğŸ‘¾','ğŸ°','ğŸ°']
    ];

    createApp({
        setup() {
            // Data
            const currentUser = ref(null);
            const loginForm = ref({ username: '', password: '' });
            const isRegistering = ref(false);
            const isLoading = ref(false);
            const errorMessage = ref('');
            
            const modalType = ref(null); 
            const modalError = ref('');
            const modalTitle = ref('');
            const friendNameInput = ref('');
            const profileForm = ref({ newUsername: '', newPassword: '' });

            const friends = ref([]);
            const currentChat = ref(null);
            const messages = ref([]);
            const newMessage = ref('');
            const isConnected = ref(false);
            
            const showEmoji = ref(false);
            const emojiTab = ref(0);
            const previewImg = ref(null);
            const contextMenu = ref({ visible: false, x: 0, y: 0, msg: null });
            
            // Audio
            const isRecording = ref(false);
            const playingAudioId = ref(null);
            const playProgress = ref(0);
            let mediaRecorder = null;
            let audioChunks = [];
            let currentAudioObj = null;
            let progressInterval = null;

            let pollingInterval = null;

            onMounted(() => {
                const saved = localStorage.getItem('11s_user');
                if (saved) { try { currentUser.value = JSON.parse(saved); loadFriends(); startPolling(); setupRealtime(); } catch(e) {} }
            });

            onUnmounted(() => {
                if (pollingInterval) clearInterval(pollingInterval);
                stopAudio();
            });

            const currentEmojis = computed(() => EMOJI_CATEGORIES[emojiTab.value]);

            const openModal = (type) => {
                modalType.value = type; modalError.value = '';
                if (type === 'addFriend') { modalTitle.value = 'å¯»æ‰¾ä¼™ä¼´'; friendNameInput.value = ''; }
                if (type === 'editProfile') { modalTitle.value = 'ä¸ªäººè®¾ç½®'; profileForm.value = { newUsername: currentUser.value.username, newPassword: '' }; }
            };
            const closeModal = () => { modalType.value = null; };

            const handleLogin = async () => {
                errorMessage.value = '';
                const { username, password } = loginForm.value;
                if (!username.trim() || !password.trim()) { errorMessage.value = "è¯·è¾“å…¥å†…å®¹"; return; }
                
                isLoading.value = true;
                const cleanName = username.trim();
                try {
                    if (isRegistering.value) {
                        const { data: exist } = await sb.from('chat_users').select('id').eq('username', cleanName).maybeSingle();
                        if (exist) throw new Error("ç”¨æˆ·åå·²å­˜åœ¨");
                        const { data: newUser, error } = await sb.from('chat_users').insert({ username: cleanName, password }).select().single();
                        if (error) throw error;
                        loginSuccess(newUser);
                    } else {
                        const { data: user, error } = await sb.from('chat_users').select('*').eq('username', cleanName).maybeSingle();
                        if (error || !user || user.password !== password) throw new Error("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯");
                        loginSuccess(user);
                    }
                } catch (e) { errorMessage.value = e.message || "å¤±è´¥"; }
                isLoading.value = false;
            };

            const updateProfile = async () => {
                const { newUsername, newPassword } = profileForm.value;
                if (!newUsername.trim()) { modalError.value = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"; return; }
                isLoading.value = true;
                const updates = { username: newUsername.trim() };
                if (newPassword.trim()) updates.password = newPassword.trim();
                try {
                    const { error } = await sb.from('chat_users').update(updates).eq('id', currentUser.value.id);
                    if (error) throw error;
                    currentUser.value = { ...currentUser.value, ...updates };
                    localStorage.setItem('11s_user', JSON.stringify(currentUser.value));
                    alert("ä¿®æ”¹æˆåŠŸ"); closeModal();
                } catch(e) { modalError.value = "ä¿®æ”¹å¤±è´¥: " + e.message; }
                isLoading.value = false;
            };

            const loginSuccess = (user) => {
                currentUser.value = user; localStorage.setItem('11s_user', JSON.stringify(user));
                loadFriends(); startPolling(); setupRealtime(); loginForm.value = { username: '', password: '' };
            };
            const logout = () => { localStorage.removeItem('11s_user'); location.reload(); };
            const toggleMode = () => isRegistering.value = !isRegistering.value;

            const loadFriends = async () => {
                const { data: f1 } = await sb.from('chat_friends').select('friend_id').eq('user_id', currentUser.value.id);
                const { data: f2 } = await sb.from('chat_friends').select('user_id').eq('friend_id', currentUser.value.id);
                const ids = [...new Set([...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)])];
                if (ids.length > 0) {
                    const { data } = await sb.from('chat_users').select('*').in('id', ids);
                    const friendsWithData = await Promise.all(data.map(async u => {
                        const { data: last } = await sb.from('chat_messages').select('*').or(`sender_id.eq.${u.id},receiver_id.eq.${u.id}`).or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`).order('created_at', { ascending: false }).limit(1);
                        const { count } = await sb.from('chat_messages').select('*', { count: 'exact', head: true }).eq('sender_id', u.id).eq('receiver_id', currentUser.value.id).eq('is_read', false);
                        return { ...u, unread: count || 0, lastMsg: last?.[0] };
                    }));
                    friends.value = friendsWithData;
                }
            };

            const addFriend = async () => {
                if (!friendNameInput.value) return;
                isLoading.value = true; modalError.value = '';
                try {
                    const { data: target } = await sb.from('chat_users').select('*').eq('username', friendNameInput.value.trim()).maybeSingle();
                    if (!target) throw new Error("ç”¨æˆ·ä¸å­˜åœ¨");
                    if (target.id === currentUser.value.id) throw new Error("ä¸èƒ½æ·»åŠ è‡ªå·±");
                    const { error } = await sb.from('chat_friends').insert({ user_id: currentUser.value.id, friend_id: target.id });
                    if (error) throw new Error("æ·»åŠ å¤±è´¥ï¼ˆå¯èƒ½å·²æ˜¯å¥½å‹ï¼‰");
                    alert("æ·»åŠ æˆåŠŸ"); closeModal(); loadFriends();
                } catch (e) { modalError.value = e.message; }
                isLoading.value = false;
            };

            const selectChat = async (friend) => {
                currentChat.value = friend;
                friend.unread = 0;
                await loadMessages();
                markAsRead();
                // ç§»åŠ¨ç«¯ï¼šåˆ‡æ¢è§†å›¾
                if (window.innerWidth <= 768) {
                    nextTick(() => document.querySelector('.main-chat').classList.add('active'));
                }
            };
            
            const backToFriends = () => {
                currentChat.value = null; // å¯é€‰ï¼šä¿æŒçŠ¶æ€ä½†éšè—ç•Œé¢
                document.querySelector('.main-chat').classList.remove('active');
            };

            const loadMessages = async () => {
                if (!currentChat.value) return;
                const { data } = await sb.from('chat_messages').select('*').or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`).order('created_at', { ascending: true });
                messages.value = (data || []).filter(m => (m.sender_id === currentUser.value.id && m.receiver_id === currentChat.value.id) || (m.sender_id === currentChat.value.id && m.receiver_id === currentUser.value.id));
                scrollToBottom();
            };

            const sendMessage = async () => {
                if (!newMessage.value.trim() && !newMessage.value.startsWith('img::')) return;
                const content = newMessage.value; newMessage.value = ''; showEmoji.value = false;
                const tempMsg = { id: Date.now(), sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content, msg_type: 'text', created_at: new Date().toISOString() };
                messages.value.push(tempMsg); scrollToBottom();
                await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content, msg_type: 'text' });
            };

            const startPolling = () => {
                if (pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(() => { if(currentChat.value) loadMessages(); loadFriends(); }, 3000);
            };

            // Voice Logic
            const startRecord = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = sendVoice;
                    mediaRecorder.start();
                    isRecording.value = true;
                } catch(e) { alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»"); }
            };
            const stopRecord = () => { if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); isRecording.value = false; } };
            const sendVoice = async () => {
                if (audioChunks.length === 0) return;
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const duration = Math.ceil(blob.size / 5000);
                const fileName = `voice_${Date.now()}.webm`;
                try {
                    const { error } = await sb.storage.from('chat-uploads').upload(fileName, blob);
                    if(!error) {
                        const { data } = sb.storage.from('chat-uploads').getPublicUrl(fileName);
                        await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, msg_type: 'voice', file_url: data.publicUrl, file_name: duration + 's', content: '[è¯­éŸ³]' });
                    }
                } catch(e) { alert("å‘é€å¤±è´¥"); }
            };
            const toggleVoice = (msg) => {
                if (playingAudioId.value === msg.id) { stopAudio(); return; }
                stopAudio();
                const audio = new Audio(msg.file_url);
                currentAudioObj = audio;
                playingAudioId.value = msg.id;
                audio.play();
                progressInterval = setInterval(() => { if(audio.duration) playProgress.value = (audio.currentTime / audio.duration) * 100; }, 100);
                audio.onended = stopAudio;
            };
            const stopAudio = () => {
                if (currentAudioObj) { currentAudioObj.pause(); currentAudioObj = null; }
                if (progressInterval) clearInterval(progressInterval);
                playingAudioId.value = null; playProgress.value = 0;
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const type = file.type.startsWith('image/') ? 'image' : 'file';
                const fileName = `${Date.now()}_${file.name}`;
                try {
                    const { error } = await sb.storage.from('chat-uploads').upload(fileName, file);
                    if (error) throw error;
                    const { data } = sb.storage.from('chat-uploads').getPublicUrl(fileName);
                    await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, msg_type: type, file_url: data.publicUrl, file_name: file.name, content: type==='image'?'[å›¾ç‰‡]':'[æ–‡ä»¶]' });
                } catch(err) { alert("ä¸Šä¼ å¤±è´¥"); }
            };
            
            const recallMessage = async () => {
                await sb.from('chat_messages').update({ is_recalled: true }).eq('id', contextMenu.value.msg.id);
                closeMenus();
            };
            const deleteMessage = () => {
                messages.value = messages.value.filter(m => m.id !== contextMenu.value.msg.id);
                closeMenus();
            };
            
            const getPreviewText = (msg) => {
                if (!msg) return 'æš‚æ— æ¶ˆæ¯';
                if (msg.is_recalled) return 'æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
                if (msg.msg_type === 'image') return '[å›¾ç‰‡]';
                if (msg.msg_type === 'voice') return '[è¯­éŸ³]';
                if (msg.msg_type === 'file') return '[æ–‡ä»¶]';
                return msg.content;
            };

            const setupRealtime = () => {
                sb.removeAllChannels();
                sb.channel('public:chat_messages').on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, () => {
                    if(currentChat.value) loadMessages();
                    loadFriends();
                }).subscribe(s => isConnected.value = s === 'SUBSCRIBED');
            };

            const triggerFileUpload = () => document.getElementById('fileInput').click();
            const addEmoji = (em) => newMessage.value += em;
            const handleClickOutside = () => { showEmoji.value = false; contextMenu.value.visible = false; };
            const showContextMenu = (e, msg) => { if(msg.sender_id === currentUser.value.id && !msg.is_recalled) contextMenu.value = { visible: true, x: e.clientX, y: e.clientY, msg }; };
            const handleMsgClick = (e, msg) => { if (window.innerWidth <= 768 && msg.sender_id === currentUser.value.id && !msg.is_recalled) { e.preventDefault(); showContextMenu(e, msg); } };
            const closeMenus = () => contextMenu.value.visible = false;
            const markAsRead = async () => { if(currentChat.value) await sb.from('chat_messages').update({ is_read: true }).eq('sender_id', currentChat.value.id).eq('receiver_id', currentUser.value.id).eq('is_read', false); };
            const scrollToBottom = () => nextTick(() => { const c = document.getElementById('msg-container'); if(c) c.scrollTop = c.scrollHeight; });
            const formatTime = (iso) => { const d = new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };
            const canRecall = computed(() => contextMenu.value.msg && ((new Date() - new Date(contextMenu.value.msg.created_at)) / 1000 / 60) < 2);

            return {
                currentUser, loginForm, isRegistering, isLoading, errorMessage, friends, currentChat, messages, newMessage, isConnected, showEmoji, emojiTab, currentEmojis, previewImg, contextMenu, canRecall, isRecording, playingAudioId, playProgress, modalType, modalError, modalTitle, friendNameInput, profileForm,
                handleLogin, logout, toggleMode, openModal, closeModal, updateProfile, addFriend, selectChat, sendMessage, formatTime, addEmoji, triggerFileUpload, handleFileUpload, startRecord, stopRecord, toggleVoice, showContextMenu, recallMessage, deleteMessage, closeMenus, markAsRead, handleClickOutside, getPreviewText, backToFriends, handleMsgClick
            };
        }
    }).mount('#app');
</script>
</body>
</html>
