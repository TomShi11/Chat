<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>11s Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìú</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-paper: #f7f1e3; --bg-sidebar: #f0e6d2; --bg-accent: #c0b298;     
            --text-main: #2c241b; --text-light: #857a6e; --border: #dcd3c1;
            --msg-sent: #e2dcc8; --msg-received: #ffffff;  
            --btn-primary: #5c4b3c; --btn-hover: #3e3228;
            --blue-read: #3498db; --danger: #ef4444; --success: #2ecc71;
            --radius: 12px;
            --shadow-pop: 0 4px 16px rgba(44, 36, 27, 0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-paper); color: var(--text-main);
            font-family: "Georgia", "Songti SC", "Microsoft YaHei", serif;
            height: 100vh; height: 100dvh; width: 100vw;
            display: block; overflow: hidden;
        }

        #app { width: 100%; height: 100%; display: flex; position: relative; background: #fff; }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; z-index: 20;
            padding-top: max(20px, env(safe-area-inset-top)); flex-shrink: 0;
        }
        .brand { font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-left: auto; transition: 0.3s; }
        .conn-dot.online { background: #2ecc71; box-shadow: 0 0 6px #2ecc71; }
        
        /* ‰æßËæπÊ†è Tabs */
        .sidebar-tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid rgba(0,0,0,0.05); }
        .sb-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; font-size: 14px; font-weight: bold; color: var(--text-light); transition: 0.2s; }
        .sb-tab.active { color: var(--text-main); border-bottom: 2px solid var(--btn-primary); }
        .sb-tab:hover { background: rgba(0,0,0,0.03); }

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 12px; color: var(--text-light); padding: 0 5px; }
        .icon-btn { cursor: pointer; padding: 5px; font-size: 18px; transition: 0.2s; } .icon-btn:hover { color: var(--text-main); transform: scale(1.1); }

        .chat-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; }
        .list-item { padding: 10px; border-radius: var(--radius); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; }
        .list-item:hover { background: rgba(255,255,255,0.4); }
        .list-item.active { background: #fff; border-color: rgba(0,0,0,0.05); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .avatar { 
            width: 42px; height: 42px; background: var(--bg-accent); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; 
            color: #fff; font-size: 16px; flex-shrink: 0; text-transform: uppercase;
        }
        .info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .name { font-weight: bold; font-size: 15px; }
        .preview { font-size: 12px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8; }
        .badge { min-width: 18px; height: 18px; background: var(--danger); color: white; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; padding: 0 5px; }

        .user-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; padding-bottom: env(safe-area-inset-bottom); }

        /* --- Main Chat --- */
        .main-chat {
            flex: 1; display: flex; flex-direction: column; position: relative; z-index: 10;
            background-color: var(--bg-paper);
            background-image: radial-gradient(#d4cbb8 1px, transparent 1px); background-size: 24px 24px;
            min-width: 0;
        }
        .chat-header {
            height: 64px; padding: 0 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(253, 246, 227, 0.95); backdrop-filter: blur(12px);
            padding-top: env(safe-area-inset-top); height: calc(64px + env(safe-area-inset-top));
            align-items: flex-end; padding-bottom: 15px; flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 17px; }
        .back-btn { display: none; font-size: 24px; cursor: pointer; }

        .chat-area { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; gap: 20px; scroll-behavior: auto; }
        
        /* Ê∂àÊÅØË°åÔºöÂåÖÂê´Â§¥ÂÉèÂíåÊ∞îÊ≥° */
        .msg-row { display: flex; gap: 10px; max-width: 85%; align-items: flex-end; }
        .msg-row.sent { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.received { align-self: flex-start; }
        
        .msg-avatar { 
            width: 36px; height: 36px; border-radius: 50%; background: var(--bg-accent);
            display: flex; align-items: center; justify-content: center; 
            color: #fff; font-size: 14px; font-weight: bold; flex-shrink: 0;
            margin-bottom: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .bubble-wrapper { display: flex; flex-direction: column; gap: 2px; max-width: 100%; }
        .sender-name { font-size: 10px; color: var(--text-light); margin: 0 4px; opacity: 0.8; }
        .msg-row.sent .sender-name { text-align: right; }

        .bubble {
            padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.5;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05); position: relative; word-wrap: break-word; min-width: 40px;
        }
        .msg-row.sent .bubble { background: var(--msg-sent); border-bottom-right-radius: 2px; }
        .msg-row.received .bubble { background: var(--msg-received); border-bottom-left-radius: 2px; }
        .bubble.recalled { background: rgba(0,0,0,0.03); color: #999; font-style: italic; font-size: 13px; padding: 6px 12px; }

        .msg-img { max-width: 100%; border-radius: 8px; cursor: zoom-in; display: block; max-height: 300px; }
        .voice-player { display: flex; align-items: center; gap: 8px; width: 180px; height: 34px; cursor: pointer; }
        .v-btn { font-size: 20px; color: var(--btn-primary); display: flex; }
        .v-track { flex: 1; height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; }
        .v-prog { height: 100%; background: var(--btn-primary); width: 0%; transition: width 0.1s linear; }
        .v-time { font-size: 12px; color: var(--text-light); min-width: 24px; text-align: right; }
        .file-content { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.04); padding: 8px; border-radius: 8px; text-decoration: none; color: var(--text-main); font-size: 13px; }

        .msg-meta { display: flex; align-items: center; gap: 4px; margin-top: 2px; font-size: 10px; opacity: 0.5; justify-content: flex-end; }
        .read-icon { font-size: 14px; line-height: 1; color: #aaa; transition: color 0.3s; }
        .read-icon.read { color: var(--blue-read); }

        /* Footer */
        .chat-footer {
            padding: 10px 15px; background: #fff; border-top: 1px solid var(--border);
            display: flex; align-items: flex-end; gap: 8px; min-height: 70px;
            padding-bottom: max(15px, env(safe-area-inset-bottom)); flex-shrink: 0;
            position: relative;
        }
        /* ‰øÆÂ§çÔºöË°®ÊÉÖÊåâÈíÆÁßªÂà∞ËøôÈáå */
        .tool-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; 
            color: var(--text-light); font-size: 22px; cursor: pointer; flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center; transition: 0.2s; 
        }
        .tool-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .tool-btn.recording { color: var(--danger); animation: pulse 1s infinite; background: rgba(239, 68, 68, 0.1); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .input-wrapper { flex: 1; background: #fdfdfd; border: 1px solid var(--border); border-radius: 24px; padding: 6px 14px; min-height: 44px; display: flex; align-items: center; }
        .msg-input { width: 100%; border: none; background: transparent; outline: none; font-size: 16px; font-family: inherit; padding: 5px 0; max-height: 100px; resize: none; }
        .send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--btn-primary); color: #fff; border: none; font-size: 20px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(92, 75, 60, 0.2); }

        .record-confirm { flex: 1; display: flex; align-items: center; justify-content: space-between; background: #fff; border-radius: 24px; padding: 0 20px; height: 44px; border: 1px solid var(--border); }
        .record-bar { flex: 1; display: flex; align-items: center; justify-content: center; background: #fff0f0; border-radius: 24px; height: 44px; color: #e74c3c; font-weight: bold; border: 1px solid #ffcccc; user-select: none; }

        /* Ë°®ÊÉÖÈù¢Êùø */
        .emoji-box {
            position: absolute; bottom: 80px; left: 10px; width: 320px; height: 250px;
            background: #fff; border-radius: 12px; box-shadow: var(--shadow-pop); border: 1px solid var(--border);
            z-index: 50; display: flex; flex-direction: column; overflow: hidden; animation: popUp 0.2s ease-out;
        }
        @keyframes popUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .emoji-nav { display: flex; border-bottom: 1px solid #eee; background: #fcfcfc; }
        .e-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; opacity: 0.6; } .e-tab.active { opacity: 1; border-bottom: 2px solid var(--btn-primary); background: #fff; }
        .emoji-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .e-item { font-size: 26px; cursor: pointer; padding: 5px; text-align: center; color: #000; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .main-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 20; }
            .main-chat.active { transform: translateX(0); }
            .back-btn { display: block; }
            .chat-footer { padding: 10px; gap: 5px; }
            .emoji-box { width: 96%; left: 2%; bottom: 80px; }
            .msg-row { max-width: 90%; }
        }

        /* Modals & Utils */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: #fffbf0; width: 340px; padding: 30px; border-radius: 16px; box-shadow: var(--shadow-pop); border: 1px solid var(--border); text-align: center; position: relative; }
        .m-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; outline: none; background: #fff; font-size: 16px; }
        .m-btn { width: 100%; padding: 12px; background: var(--btn-primary); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .ctx-menu { position: fixed; background: #fff; border-radius: 8px; box-shadow: var(--shadow-pop); padding: 5px 0; z-index: 200; min-width: 120px; border: 1px solid var(--border); }
        .ctx-item { padding: 12px 16px; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .ctx-item:active { background: #f5f5f5; } .ctx-item.del { color: var(--danger); }
        .img-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; cursor: zoom-out; }
        .img-full { max-width:100%; max-height:100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="app" @click="closePopups">
    <div class="img-modal" v-if="previewUrl" @click="previewUrl = null"><img :src="previewUrl" class="img-full"></div>

    <div class="ctx-menu" v-if="ctxMenu.show" :style="{top:ctxMenu.y+'px', left:ctxMenu.x+'px'}" @click.stop>
        <div class="ctx-item" v-if="canRecall" @click="recallMsg"><i class="bi bi-arrow-counterclockwise"></i> Êí§Âõû</div>
        <div class="ctx-item del" @click="deleteMsg"><i class="bi bi-trash"></i> Âà†Èô§(Êú¨Âú∞)</div>
    </div>

    <!-- ÁôªÂΩï -->
    <div class="modal-mask" v-if="!currentUser">
        <div class="modal">
            <h2 style="margin-bottom:20px;">11s Chat</h2>
            <input type="text" class="m-input" v-model="loginForm.username" placeholder="Áî®Êà∑Âêç" @keyup.enter="handleLogin">
            <input type="password" class="m-input" v-model="loginForm.password" placeholder="ÂØÜÁ†Å" @keyup.enter="handleLogin">
            <button class="m-btn" @click="handleLogin" :disabled="loading">{{ loading ? 'Loading...' : (isRegistering ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï') }}</button>
            <div style="margin-top:15px; font-size:13px; color:#888; cursor:pointer;" @click="isRegistering = !isRegistering; errorMsg=''">{{ isRegistering ? 'ËøîÂõûÁôªÂΩï' : 'ÂàõÂª∫Êñ∞Ë¥¶Âè∑' }}</div>
            <div style="color:var(--danger); font-size:13px; margin-top:10px;">{{ errorMsg }}</div>
        </div>
    </div>

    <!-- ÂºπÁ™ó -->
    <div class="modal-mask" v-if="modalType">
        <div class="modal">
            <i class="bi bi-x close-modal" @click="closeModal"></i>
            <h3 style="margin-bottom:15px;">{{ modalTitle }}</h3>
            <template v-if="modalType === 'addFriend' || modalType === 'addGroup'">
                <!-- Âä†Â•ΩÂèã -->
                <div v-if="modalType === 'addFriend'">
                    <input type="text" class="m-input" v-model="modalInput" placeholder="ËæìÂÖ•Áî®Êà∑Âêç">
                    <button class="m-btn" @click="addFriend" :disabled="loading">Ê∑ªÂä†</button>
                </div>
                <!-- Âª∫Áæ§ -->
                <div v-else>
                    <input type="text" class="m-input" v-model="modalInput" placeholder="Áæ§ÂêçÁß∞">
                    <button class="m-btn" @click="createGroup" :disabled="loading">ÂàõÂª∫</button>
                </div>
            </template>
            <template v-if="modalType === 'inviteMember'">
                <input type="text" class="m-input" v-model="modalInput" placeholder="ËæìÂÖ•Â•ΩÂèãÁî®Êà∑Âêç">
                <button class="m-btn" @click="inviteMember" :disabled="loading">ÊãâÂÖ•Áæ§ËÅä</button>
            </template>
            <template v-if="modalType === 'editProfile'">
                <input type="text" class="m-input" v-model="profileForm.username" placeholder="Êñ∞Áî®Êà∑Âêç">
                <input type="password" class="m-input" v-model="profileForm.password" placeholder="Êñ∞ÂØÜÁ†Å (ÁïôÁ©∫‰∏çÊîπ)">
                <button class="m-btn" @click="updateProfile" :disabled="loading">‰øùÂ≠ò</button>
            </template>
            <div style="color:var(--danger); font-size:13px; margin-top:10px;" v-if="modalError">{{ modalError }}</div>
        </div>
    </div>

    <template v-if="currentUser">
        <div class="sidebar" :class="{ hidden: currentChat && isMobile }">
            <div class="brand"><span><i class="bi bi-feather"></i> 11s Chat</span><div class="conn-dot" :class="{ online: isConnected }"></div></div>
            
            <!-- Tabs -->
            <div class="sidebar-tabs">
                <div class="sb-tab" :class="{active: activeTab==='friend'}" @click="activeTab='friend'">Â•ΩÂèã</div>
                <div class="sb-tab" :class="{active: activeTab==='group'}" @click="activeTab='group'">Áæ§ÁªÑ</div>
            </div>

            <!-- Â•ΩÂèãÂàóË°® -->
            <div class="chat-list" v-if="activeTab==='friend'">
                <div class="list-header"><span>ÊàëÁöÑÂ•ΩÂèã</span><i class="bi bi-person-plus icon-btn" @click="openModal('addFriend')"></i></div>
                <div v-for="f in friends" :key="f.id" class="friend-item" :class="{active: currentChat?.id===f.id && currentChat?.type==='friend'}" @click="openChat(f, 'friend')">
                    <div class="avatar">{{ f.username.charAt(0) }}</div>
                    <div class="friend-info">
                        <div class="friend-top"><span class="friend-name">{{ f.username }}</span><span class="friend-time" v-if="f.lastMsg">{{ formatTime(f.lastMsg.created_at, true) }}</span></div>
                        <div class="friend-top"><span class="friend-msg">{{ getPreview(f.lastMsg) }}</span><div class="unread-dot" v-if="f.unread > 0">{{ f.unread }}</div></div>
                    </div>
                </div>
                <div v-if="friends.length===0" style="text-align:center; padding:30px; font-size:12px; color:#999;">ÊöÇÊó†Â•ΩÂèã</div>
            </div>

            <!-- Áæ§ÁªÑÂàóË°® -->
            <div class="chat-list" v-else>
                <div class="list-header"><span>ÊàëÁöÑÁæ§ÁªÑ</span><i class="bi bi-plus-square icon-btn" @click="openModal('addGroup')"></i></div>
                <div v-for="g in groups" :key="g.id" class="friend-item" :class="{active: currentChat?.id===g.id && currentChat?.type==='group'}" @click="openChat(g, 'group')">
                    <div class="avatar" style="background:var(--text-main)">{{ g.name.charAt(0) }}</div>
                    <div class="friend-info">
                        <div class="friend-top"><span class="friend-name">{{ g.name }}</span></div>
                    </div>
                </div>
                <div v-if="groups.length===0" style="text-align:center; padding:30px; font-size:12px; color:#999;">ÊöÇÊó†Áæ§ÁªÑ</div>
            </div>

            <div class="user-footer">
                <div style="display:flex; align-items:center; gap:10px;"><div class="avatar" style="width:32px; height:32px; font-size:14px; background:var(--text-main);">{{ currentUser.username.charAt(0) }}</div><span class="user-name">{{ currentUser.username }}</span></div>
                <div style="display:flex; gap:10px; font-size:18px; color:var(--text-light);"><i class="bi bi-gear-fill icon-btn" @click="openModal('editProfile')"></i><i class="bi bi-box-arrow-right icon-btn" @click="logout"></i></div>
            </div>
        </div>

        <div class="main-chat" :class="{ active: currentChat }">
            <template v-if="currentChat">
                <div class="chat-header">
                    <div class="header-left">
                        <i class="bi bi-chevron-left back-btn" @click="closeChat"></i>
                        <span>{{ currentChat.type === 'friend' ? currentChat.username : currentChat.name }}</span>
                    </div>
                    <i v-if="currentChat.type === 'group'" class="bi bi-person-plus icon-btn" @click="openModal('inviteMember')" title="Êãâ‰∫∫ËøõÁæ§"></i>
                </div>
                
                <div class="chat-area" id="msg-box" @click="showEmoji=false">
                    <div v-for="msg in messages" :key="msg.id" class="msg-row" :class="msg.sender_id === currentUser.id ? 'sent' : 'received'">
                        <!-- Â§¥ÂÉè -->
                        <div v-if="msg.sender_id !== currentUser.id" class="msg-avatar">
                            {{ getSenderInitial(msg.sender_id) }}
                        </div>
                        
                        <div class="bubble-wrapper">
                            <!-- Áæ§ËÅäÊòæÁ§∫ÂèëÈÄÅËÄÖÂêçÂ≠ó -->
                            <div v-if="currentChat.type === 'group' && msg.sender_id !== currentUser.id" class="sender-name">
                                {{ getSenderName(msg.sender_id) }}
                            </div>

                            <div class="bubble" :class="{ recalled: msg.is_recalled }" 
                                 @contextmenu.prevent="openCtxMenu($event, msg)"
                                 @touchstart="handleTouchStart($event, msg)" @touchend="handleTouchEnd" @touchmove="handleTouchMove">
                                
                                <template v-if="msg.is_recalled"><i class="bi bi-arrow-counterclockwise"></i> Êí§Âõû</template>
                                <template v-else>
                                    <div v-if="msg.msg_type === 'text'">{{ msg.content }}</div>
                                    <img v-else-if="msg.msg_type === 'image'" :src="msg.file_url" class="msg-img" @click.stop="previewUrl = msg.file_url">
                                    <a v-else-if="msg.msg_type === 'file'" :href="msg.file_url" target="_blank" class="file-content"><i class="bi bi-file-earmark"></i> {{ msg.file_name || 'Êñá‰ª∂' }}</a>
                                    <div v-else-if="msg.msg_type === 'voice'" class="voice-player" @click.stop="toggleVoice(msg)">
                                        <div class="v-btn"><i class="bi" :class="playingId === msg.id ? 'bi-pause-fill' : 'bi-play-fill'"></i></div>
                                        <div class="v-track"><div class="v-prog" :style="{width: (playingId === msg.id ? playProgress : 0) + '%'}"></div></div>
                                        <div class="v-time">{{ msg.file_name?.replace(/[^\d]/g, '') || '0' }}s</div>
                                    </div>
                                </template>
                            </div>
                            <div class="msg-meta" v-if="!msg.is_recalled">
                                <span v-if="msg.sender_id === currentUser.id" class="read-icon" :class="{ read: msg.is_read }"><i class="bi" :class="msg.is_read ? 'bi-check2-all' : 'bi-check2'"></i></span>
                                <span>{{ formatTime(msg.created_at) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <template v-if="voiceBlob">
                        <div class="record-confirm">
                            <span style="font-size:13px; color:#555;">ËØ≠Èü≥ÂæÖÂèëÈÄÅ</span>
                            <div style="display:flex; gap:15px;">
                                <i class="bi bi-play-circle-fill rc-btn" style="color:var(--text-main);" @click="playDraftVoice"></i>
                                <i class="bi bi-x-circle-fill rc-btn" style="color:var(--danger);" @click="voiceBlob=null"></i>
                                <i class="bi bi-check-circle-fill rc-btn" style="color:var(--success);" @click="uploadVoice"></i>
                            </div>
                        </div>
                    </template>
                    <template v-else-if="isRecording">
                        <div class="record-bar" @mouseup="stopRecord" @touchend="stopRecord"><i class="bi bi-mic-fill"></i> ÊùæÂºÄÁªìÊùüÂΩïÈü≥</div>
                    </template>
                    <template v-else>
                        <button class="tool-btn" @click="triggerFile"><i class="bi bi-paperclip"></i></button>
                        <input type="file" id="fileInput" hidden @change="handleFile">
                        <button class="tool-btn" @mousedown="startRecord" @touchstart.prevent="startRecord"><i class="bi bi-mic"></i></button>
                        <button class="tool-btn" @click.stop="showEmoji = !showEmoji"><i class="bi bi-emoji-smile"></i></button>
                        
                        <div class="input-wrapper">
                            <input type="text" class="msg-input" v-model="newMessage" placeholder="ÂÜô‰ø°..." @keyup.enter="sendMessage" @focus="markRead">
                        </div>
                        <button class="send-btn" @click="sendMessage" v-if="newMessage.trim()"><i class="bi bi-arrow-up"></i></button>
                    </template>
                    <div class="emoji-box" v-if="showEmoji" @click.stop>
                        <div class="emoji-nav"><div class="e-tab" :class="{active: emojiTab===i}" v-for="(cat,i) in ['üòÄ','üêª','üçé','‚öΩ']" @click="emojiTab=i">{{cat}}</div></div>
                        <div class="emoji-grid"><div class="e-item" v-for="e in currentEmojis" @click="addEmoji(e)">{{e}}</div></div>
                    </div>
                </div>
            </template>
            <template v-else>
                <div class="empty-state d-none d-md-flex"><i class="bi bi-chat-square-quote empty-icon" style="font-size:48px;"></i><div>ÂºÄÂßãËÅäÂ§©</div></div>
            </template>
        </div>
    </template>
</div>

<script>
    const SUPABASE_URL = 'https://fznfneqwxzuwtognuoeo.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_UlNMDLt4OaYIX-_lCezGwA_8jIQLhFO';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp, ref, onMounted, nextTick, onUnmounted, computed } = Vue;

    const EMOJIS = [['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ'],['üêµ','üêí','ü¶ç','ü¶ß','üê∂','üêï','ü¶Æ','üêï‚Äçü¶∫','üê©','üê∫','ü¶ä','ü¶ù','üê±','üêà','üêà‚Äç‚¨õ','ü¶Å','üêØ','üêÖ','üêÜ','üê¥','üêé','ü¶Ñ','ü¶ì','ü¶å','üêÆ','ox','üêÉ','üêÑ','üê∑','üêñ','üêó','üêΩ','üêè','üêë','üêê','üê™','üê´','ü¶ô','ü¶ô','ü¶í','üêò','ü¶£','ü¶è','ü¶õ','üê≠','üêÅ','üêÄ','üêπ','üê∞','üêá','üêøÔ∏è','ü¶´','ü¶î','ü¶î','ü¶á','üêª','üêª‚Äç‚ùÑÔ∏è','üê®','üêº','ü¶•','ü¶¶','ü¶¶','ü¶®','üê£','üê§','üê•','üê¶','üêß','üïäÔ∏è','ü¶Ö','ü¶Ü','ü¶¢','ü¶â','ü¶§','ü¶©','ü¶ö','ü¶ú','ü¶ú','üê∏','üêä','üê¢','ü¶é','üêç','üê≤','üêâ','ü¶ï','ü¶ñ','üê≥','üêã','üê¨','üêü','üê†','üê°','ü¶à','üêô','üêö','üêå','ü¶ã','üêõ','üêú','üêù','ü™≤','üêû','ü¶ó','üï∑Ô∏è','üï∏Ô∏è','ü¶Ç','ü¶ü','ü™∞','ü™±','ü¶†'],['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üåÆ','üåØ','ü´î','ü•ó','ü•ò','ü´ï','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','üç§','üçô','üçö','üçò','üç•','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','‚òï','ü´ñ','üçµ','üç∂','üçæ','üç∑','üç∏','üçπ','üç∫','üçª','ü•Ç','ü•É','ü•§','üßã','üßÉ','üßâ','üßä','ü•¢','üçΩÔ∏è','üç¥','ü•Ñ'],['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üé±','ü™Ä','üèì','üè∏','üè∏','üèí','üèë','‚õ≥','‚õ≥','üèπ','ü•Ö','ü•Ö','ü•ä','ü•ã','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','ü•å','üéø','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','üèãÔ∏è‚Äç‚ôÇÔ∏è','üèãÔ∏è‚Äç‚ôÄÔ∏è','ü§º','ü§º‚Äç‚ôÇÔ∏è','ü§º‚Äç‚ôÄÔ∏è','ü§∏','ü§∏‚Äç‚ôÇÔ∏è','ü§∏‚Äç‚ôÄÔ∏è','‚õπÔ∏è','‚õπÔ∏è‚Äç‚ôÇÔ∏è','‚õπÔ∏è‚Äç‚ôÄÔ∏è','ü§∫','ü§æ','ü§æ‚Äç‚ôÇÔ∏è','ü§æ‚Äç‚ôÄÔ∏è','üèåÔ∏è','üèåÔ∏è‚Äç‚ôÇÔ∏è','üèåÔ∏è‚Äç‚ôÄÔ∏è','üèá','üßò','üßò‚Äç‚ôÇÔ∏è','üßò‚Äç‚ôÄÔ∏è','üèÑ','üèÑ‚Äç‚ôÇÔ∏è','üèÑ‚Äç‚ôÄÔ∏è','üèä','üèä‚Äç‚ôÇÔ∏è','üèä‚Äç‚ôÄÔ∏è','ü§Ω','ü§Ω‚Äç‚ôÇÔ∏è','ü§Ω‚Äç‚ôÄÔ∏è','üö£','üö£‚Äç‚ôÇÔ∏è','üö£‚Äç‚ôÄÔ∏è','üßó','üßó‚Äç‚ôÇÔ∏è','üßó‚Äç‚ôÄÔ∏è','üöµ','üöµ‚Äç‚ôÇÔ∏è','üöµ‚Äç‚ôÄÔ∏è','üö¥','üö¥‚Äç‚ôÇÔ∏è','üö¥‚Äç‚ôÄÔ∏è','üèÜ','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üèµÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','ü§π','ü§π‚Äç‚ôÇÔ∏è','ü§π‚Äç‚ôÄÔ∏è','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéπ','ü•Å','üé∑','üé∫','üé∏','ü™ï','üéª','üé≤','üß©','‚ôüÔ∏è','üéØ','üé≥','ü™Ä','ü™Å','üéÆ','üëæ','üé∞','üé∞']];

    createApp({
        setup() {
            const currentUser = ref(null);
            const loginForm = ref({ username: '', password: '' });
            const isRegistering = ref(false);
            const loading = ref(false);
            const errorMessage = ref('');
            
            const activeTab = ref('friend'); // friend | group
            const friends = ref([]);
            const groups = ref([]);
            const allUsersCache = ref({}); // id -> username mapping
            
            const currentChat = ref(null); // { id, username/name, type: 'friend'|'group' }
            const messages = ref([]);
            const newMessage = ref('');
            const isConnected = ref(false);
            const isMobile = ref(window.innerWidth <= 768);
            
            const modalType = ref(null); const modalError = ref(''); const modalTitle = ref(''); const modalInput = ref(''); const profileForm = ref({ username: '', password: '' });
            const previewUrl = ref(null); const showEmoji = ref(false); const emojiTab = ref(0); const ctxMenu = ref({ show: false, x: 0, y: 0, msg: null });
            
            const isRecording = ref(false); const voiceBlob = ref(null); const playingId = ref(null); const playProgress = ref(0);
            let mediaRecorder = null; let audioChunks = []; let currentAudio = null; let progInterval = null; let pollingInterval = null; let touchTimer = null;

            const currentEmojis = computed(() => EMOJIS[emojiTab.value]);
            const canRecall = computed(() => ctxMenu.value.msg && (new Date() - new Date(ctxMenu.value.msg.created_at)) / 1000 / 60 < 2);

            onMounted(() => {
                const saved = localStorage.getItem('11s_user');
                if (saved) { try { currentUser.value = JSON.parse(saved); initSystem(); } catch(e){} }
                window.addEventListener('resize', ()=>isMobile.value=window.innerWidth<=768);
            });
            onUnmounted(() => { if(pollingInterval) clearInterval(pollingInterval); stopAudio(); });

            // Auth
            const handleLogin = async () => {
                errorMessage.value = ''; if(!loginForm.value.username) return;
                loading.value = true;
                const u = loginForm.value.username.trim(), p = loginForm.value.password;
                try {
                    if (isRegistering.value) {
                        const {data:e} = await sb.from('chat_users').select('id').eq('username', u).maybeSingle();
                        if(e) throw new Error("Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®");
                        const {data:n, error} = await sb.from('chat_users').insert({username:u, password:p}).select().single();
                        if(error) throw error; loginOk(n);
                    } else {
                        const {data:user, error} = await sb.from('chat_users').select('*').eq('username', u).maybeSingle();
                        if(error || !user || user.password !== p) throw new Error("Â§±Ë¥•");
                        loginOk(user);
                    }
                } catch(e) { errorMessage.value = e.message; }
                loading.value = false;
            };
            const loginOk = (u) => { currentUser.value=u; localStorage.setItem('11s_user',JSON.stringify(u)); loginForm.value={username:'',password:''}; initSystem(); };
            const logout = () => { localStorage.removeItem('11s_user'); location.reload(); };
            const initSystem = () => { loadFriends(); loadGroups(); setupRealtime(); startPolling(); };

            // Data Loading
            const loadFriends = async () => {
                if(!currentUser.value) return;
                const { data: f1 } = await sb.from('chat_friends').select('friend_id').eq('user_id', currentUser.value.id);
                const { data: f2 } = await sb.from('chat_friends').select('user_id').eq('friend_id', currentUser.value.id);
                const ids = [...new Set([...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)])];
                if(ids.length > 0) {
                    const { data: users } = await sb.from('chat_users').select('*').in('id', ids);
                    // Cache names
                    users.forEach(u => allUsersCache.value[u.id] = u.username);
                    
                    const list = await Promise.all(users.map(async u => {
                        const { data: msgs } = await sb.from('chat_messages').select('*').or(`sender_id.eq.${u.id},receiver_id.eq.${u.id}`).or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`).order('created_at', { ascending: false }).limit(1);
                        const { count } = await sb.from('chat_messages').select('*', { count: 'exact', head: true }).eq('sender_id', u.id).eq('receiver_id', currentUser.value.id).eq('is_read', false);
                        return { ...u, unread: count || 0, lastMsg: msgs?.[0] };
                    }));
                    friends.value = list.sort((a,b) => new Date(b.lastMsg?.created_at||0) - new Date(a.lastMsg?.created_at||0));
                }
            };

            const loadGroups = async () => {
                // Get groups I am a member of
                const { data: members } = await sb.from('chat_group_members').select('group_id').eq('user_id', currentUser.value.id);
                const groupIds = members?.map(m => m.group_id) || [];
                if(groupIds.length > 0) {
                    const { data: grps } = await sb.from('chat_groups').select('*').in('id', groupIds);
                    groups.value = grps.map(g => ({...g, type:'group'}));
                }
            };

            // Chat Ops
            const openChat = async (target, type) => {
                currentChat.value = { ...target, type };
                if (type === 'friend') target.unread = 0;
                await loadMessages();
                markRead();
                if(isMobile.value) nextTick(() => document.querySelector('.main-chat').classList.add('active'));
            };
            const closeChat = () => { document.querySelector('.main-chat').classList.remove('active'); setTimeout(() => currentChat.value = null, 300); };
            
            const loadMessages = async () => {
                if(!currentChat.value) return;
                let q = sb.from('chat_messages').select('*').order('created_at', { ascending: true });
                
                if (currentChat.value.type === 'group') {
                    q = q.eq('group_id', currentChat.value.id);
                } else {
                    // Private
                    q = q.or(`and(sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentChat.value.id}),and(sender_id.eq.${currentChat.value.id},receiver_id.eq.${currentUser.value.id})`);
                }
                const { data } = await q;
                messages.value = data || [];
                
                // Cache senders for groups
                if(currentChat.value.type === 'group' && data) {
                    const unknownIds = [...new Set(data.map(m => m.sender_id).filter(id => !allUsersCache.value[id]))];
                    if(unknownIds.length > 0) {
                        const {data: us} = await sb.from('chat_users').select('id,username').in('id', unknownIds);
                        us?.forEach(u => allUsersCache.value[u.id] = u.username);
                    }
                }
                scrollToBottom();
            };

            const sendMessage = async () => {
                if(!newMessage.value.trim() && !newMessage.value.startsWith('img::')) return;
                const content = newMessage.value; newMessage.value = ''; showEmoji.value = false;
                
                const payload = {
                    sender_id: currentUser.value.id,
                    content, msg_type: 'text',
                };
                if(currentChat.value.type === 'group') payload.group_id = currentChat.value.id;
                else payload.receiver_id = currentChat.value.id;

                const tmp = { ...payload, id: Date.now(), created_at: new Date().toISOString(), is_read: false };
                messages.value.push(tmp); scrollToBottom();
                await sb.from('chat_messages').insert(payload);
            };

            // Modals
            const openModal = (t) => { modalType.value = t; modalError.value = ''; modalInput.value=''; modalTitle.value = t==='addFriend'?'Ê∑ªÂä†Â•ΩÂèã':(t==='addGroup'?'ÂàõÂª∫Áæ§ÁªÑ':(t==='inviteMember'?'Êãâ‰∫∫ËøõÁæ§':'‰øÆÊîπËµÑÊñô')); };
            const closeModal = () => modalType.value = null;

            const addFriend = async () => {
                loading.value = true;
                try {
                    const { data:t } = await sb.from('chat_users').select('*').eq('username', modalInput.value.trim()).maybeSingle();
                    if(!t) throw new Error("Áî®Êà∑‰∏çÂ≠òÂú®");
                    if(t.id === currentUser.value.id) throw new Error("‰∏çËÉΩÂä†Ëá™Â∑±");
                    await sb.from('chat_friends').insert({user_id:currentUser.value.id, friend_id:t.id});
                    alert("Ê∑ªÂä†ÊàêÂäü"); closeModal(); loadFriends();
                } catch(e) { modalError.value = e.message; }
                loading.value = false;
            };

            const createGroup = async () => {
                loading.value = true;
                try {
                    if(!modalInput.value.trim()) throw new Error("ËØ∑ËæìÂÖ•Áæ§Âêç");
                    const { data: g, error } = await sb.from('chat_groups').insert({ name: modalInput.value.trim(), owner_id: currentUser.value.id }).select().single();
                    if(error) throw error;
                    // Add self as member
                    await sb.from('chat_group_members').insert({ group_id: g.id, user_id: currentUser.value.id });
                    alert("ÂàõÂª∫ÊàêÂäü"); closeModal(); loadGroups();
                } catch(e) { modalError.value = e.message; }
                loading.value = false;
            };

            const inviteMember = async () => {
                loading.value = true;
                try {
                    const { data:t } = await sb.from('chat_users').select('*').eq('username', modalInput.value.trim()).maybeSingle();
                    if(!t) throw new Error("Áî®Êà∑‰∏çÂ≠òÂú®");
                    await sb.from('chat_group_members').insert({ group_id: currentChat.value.id, user_id: t.id });
                    alert("ÈÇÄËØ∑ÊàêÂäü"); closeModal();
                } catch(e) { modalError.value = e.message || "ËØ•Áî®Êà∑Â∑≤Âú®Áæ§‰∏≠"; }
                loading.value = false;
            };

            const updateProfile = async () => { /* same as before */ };

            // Realtime & Utils
            const setupRealtime = () => {
                sb.removeAllChannels();
                sb.channel('public:chat_messages').on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, p => {
                    const msg = p.new;
                    if(p.eventType === 'INSERT') {
                        let isRelevant = false;
                        if(currentChat.value) {
                            if(currentChat.value.type === 'group' && msg.group_id === currentChat.value.id) isRelevant = true;
                            if(currentChat.value.type === 'friend' && (msg.sender_id === currentChat.value.id || msg.sender_id === currentUser.value.id) && !msg.group_id) isRelevant = true;
                        }
                        if(isRelevant) {
                            if(!messages.value.some(m => m.id === msg.id)) { messages.value.push(msg); scrollToBottom(); }
                            if(msg.sender_id !== currentUser.value.id) markRead();
                        }
                        loadFriends(); // Refresh lists
                    } else if(p.eventType === 'UPDATE') {
                        const i = messages.value.findIndex(m => m.id === msg.id);
                        if(i !== -1) messages.value[i] = msg;
                    }
                }).subscribe(s => isConnected.value = s === 'SUBSCRIBED');
            };

            // Voice & File (Similar logic, adding group_id support)
            const uploadVoice = async () => {
                if(!voiceBlob.value) return;
                const duration = Math.floor(voiceBlob.value.size / 5000); 
                const name = `voice_${Date.now()}.webm`;
                const payload = { sender_id: currentUser.value.id, msg_type: 'voice', file_url: '', file_name: duration+'s' };
                if(currentChat.value.type === 'group') payload.group_id = currentChat.value.id; else payload.receiver_id = currentChat.value.id;
                
                messages.value.push({ ...payload, id: Date.now(), created_at: new Date().toISOString() }); scrollToBottom(); voiceBlob.value = null;
                
                try {
                    await sb.storage.from('chat-uploads').upload(name, voiceBlob.value);
                    const { data } = sb.storage.from('chat-uploads').getPublicUrl(name);
                    payload.file_url = data.publicUrl; payload.content = '[ËØ≠Èü≥]';
                    await sb.from('chat_messages').insert(payload);
                } catch(e) {}
            };
            const handleFile = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                const type = file.type.startsWith('image') ? 'image' : 'file';
                const name = `${Date.now()}_${file.name}`;
                try {
                    await sb.storage.from('chat-uploads').upload(name, file);
                    const { data } = sb.storage.from('chat-uploads').getPublicUrl(name);
                    const payload = { sender_id: currentUser.value.id, msg_type: type, file_url: data.publicUrl, file_name: file.name, content: type };
                    if(currentChat.value.type === 'group') payload.group_id = currentChat.value.id; else payload.receiver_id = currentChat.value.id;
                    await sb.from('chat_messages').insert(payload);
                } catch(e) { alert("‰∏ä‰º†Â§±Ë¥•"); }
            };

            const markRead = async () => { 
                if(currentChat.value?.type === 'friend') 
                    await sb.from('chat_messages').update({is_read:true}).eq('sender_id',currentChat.value.id).eq('receiver_id',currentUser.value.id).eq('is_read',false); 
            };
            const startPolling = () => { if(pollingInterval) clearInterval(pollingInterval); pollingInterval = setInterval(() => { if(currentChat.value) loadMessages(); loadFriends(); }, 3000); };
            const getSenderInitial = (id) => (allUsersCache.value[id] || '?').substring(0,1);
            const getSenderName = (id) => allUsersCache.value[id] || 'Unknown';
            const startRecord = async () => { try { const s = await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder = new MediaRecorder(s); audioChunks=[]; mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=()=>voiceBlob.value=new Blob(audioChunks,{type:'audio/webm'}); mediaRecorder.start(); isRecording.value=true; } catch(e){alert("No Mic");} };
            const stopRecord = () => { if(mediaRecorder?.state!=='inactive'){mediaRecorder.stop(); isRecording.value=false;} };
            const playDraftVoice = () => new Audio(URL.createObjectURL(voiceBlob.value)).play();
            const toggleVoice = (msg) => { if(playingId.value===msg.id){stopAudio();return;} stopAudio(); const a=new Audio(msg.file_url); currentAudio=a; playingId.value=msg.id; a.play(); progInterval=setInterval(()=>{if(a.duration)playProgress.value=(a.currentTime/a.duration)*100},100); a.onended=stopAudio; };
            const stopAudio = () => { if(currentAudio){currentAudio.pause();currentAudio=null;} clearInterval(progInterval); playingId.value=null; playProgress.value=0; };
            const triggerFile = () => document.getElementById('fileInput').click();
            const addEmoji = (e) => newMessage.value += e;
            const handleClickOutside = () => { showEmoji.value = false; ctxMenu.value.show = false; };
            const openCtxMenu = (e, msg) => { if(msg.sender_id===currentUser.value.id && !msg.is_recalled) { ctxMenu.value={show:true, x:e.clientX, y:e.clientY, msg}; } };
            const handleMobileCtx = (e, msg) => { if(isMobile.value && msg.sender_id===currentUser.value.id) { e.preventDefault(); openCtxMenu(e, msg); } };
            const handleTouchStart = (e, msg) => { if(msg.sender_id!==currentUser.value.id||msg.is_recalled)return; touchTimer=setTimeout(()=>{openCtxMenu({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY},msg); if(navigator.vibrate)navigator.vibrate(50);},500); };
            const handleTouchEnd = () => clearTimeout(touchTimer);
            const handleTouchMove = () => clearTimeout(touchTimer);
            const recallMsg = async () => { await sb.from('chat_messages').update({is_recalled:true}).eq('id', ctxMenu.value.msg.id); ctxMenu.value.show=false; };
            const deleteMsg = () => { messages.value=messages.value.filter(m=>m.id!==ctxMenu.value.msg.id); ctxMenu.value.show=false; };
            const scrollToBottom = () => nextTick(() => { const c = document.getElementById('msg-box'); if(c) c.scrollTop = c.scrollHeight+100; });
            const formatTime = (iso, short) => { const d = new Date(iso); if(short) return `${d.getMonth()+1}/${d.getDate()}`; return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`; };
            const getPreview = (m) => !m ? '' : (m.is_recalled ? 'Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ' : (m.msg_type==='text'?m.content:`[${m.msg_type}]`));

            return {
                currentUser, loginForm, isRegistering, loading, errorMessage, friends, groups, currentChat, messages, newMessage, isConnected, activeTab,
                modalType, modalError, modalTitle, modalInput, profileForm, previewUrl, showEmoji, EMOJIS, ctxMenu, canRecall, isRecording, voiceBlob, playingId, playProgress,
                handleLogin, logout, openModal, closeModal, addFriend, createGroup, inviteMember, updateProfile, openChat, closeChat,
                sendMessage, triggerFile, handleFile, startRecord, stopRecord, playDraftVoice, uploadVoice, toggleVoice,
                openCtxMenu, handleTouchStart, handleTouchEnd, handleTouchMove, recallMsg, deleteMsg, closePopups: handleClickOutside, previewImg: (u)=>previewUrl.value=u, addEmoji,
                formatTime, getPreview, markRead, onImgLoad: scrollToBottom, getSenderInitial, getSenderName
            };
        }
    }).mount('#app');
</script>
</body>
</html>
