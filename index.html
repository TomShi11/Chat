<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11s Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“œ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-paper: #fdf6e3; --bg-sidebar: #f5eacb; --bg-accent: #d4c5a3;     
            --text-main: #4a3b2a; --text-light: #8b7e74; --border: #dcd3c1;
            --msg-sent: #eaddcf; --msg-received: #ffffff;  
            --btn-primary: #5b4636; --btn-hover: #423226; --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-paper); color: var(--text-main); font-family: "Georgia", "Songti SC", serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #app { width: 100%; height: 100%; display: flex; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 280px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; z-index: 10; }
        .brand { font-size: 22px; font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .conn-status { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-left: auto; }
        .conn-status.online { background: #34c759; box-shadow: 0 0 5px #34c759; }
        
        .friend-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .friend-item { padding: 10px 12px; border-radius: var(--radius); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; }
        .friend-item:hover { background-color: rgba(255,255,255,0.5); }
        .friend-item.active { background-color: #fff; border-color: var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .avatar { width: 36px; height: 36px; background: var(--bg-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; text-transform: uppercase; }
        .user-info { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; align-items: center; gap: 12px; }

        /* èŠå¤©åŒº */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-image: radial-gradient(#dccdb3 1px, transparent 1px); background-size: 24px 24px; }
        .chat-header { padding: 18px 30px; border-bottom: 1px solid var(--border); font-size: 18px; font-weight: bold; background: rgba(253, 246, 227, 0.85); backdrop-filter: blur(10px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 16px; }
        
        .message-bubble { max-width: 70%; padding: 12px 18px; border-radius: 16px; font-size: 15px; line-height: 1.5; box-shadow: 2px 2px 6px rgba(0,0,0,0.03); word-wrap: break-word; position: relative; }
        .message-bubble.sent { align-self: flex-end; background-color: var(--msg-sent); border-bottom-right-radius: 2px; }
        .message-bubble.received { align-self: flex-start; background-color: var(--msg-received); border-bottom-left-radius: 2px; }
        
        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .msg-img { max-width: 100%; border-radius: 8px; cursor: zoom-in; display: block; margin-bottom: 4px; }
        .msg-time { font-size: 10px; opacity: 0.5; margin-top: 4px; text-align: right; display: block; }

        /* è¾“å…¥åŒºå¢å¼º */
        .chat-input-area { padding: 15px 30px; border-top: 1px solid var(--border); background: rgba(253, 246, 227, 0.9); display: flex; gap: 10px; align-items: flex-end; position: relative; }
        .toolbar-btn { background: transparent; border: none; color: var(--text-light); font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .toolbar-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        
        .input-box { flex: 1; border: 1px solid var(--border); background: #fff; padding: 12px 16px; border-radius: 20px; font-size: 15px; outline: none; resize: none; height: 46px; line-height: 20px; max-height: 120px; }
        .input-box:focus { border-color: var(--text-light); box-shadow: 0 0 0 3px rgba(91, 70, 54, 0.05); }
        
        .send-btn { background: var(--btn-primary); color: #fff; border: none; width: 46px; height: 46px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }

        /* è¡¨æƒ…é¢æ¿ */
        .emoji-picker { 
            position: absolute; bottom: 80px; left: 30px; background: #fff; 
            border: 1px solid var(--border); border-radius: 12px; padding: 10px; 
            width: 280px; height: 200px; overflow-y: auto; display: grid; 
            grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            z-index: 50; 
        }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 4px; }
        .emoji-item:hover { background: #f0f0f0; }

        /* å¤§å›¾é¢„è§ˆ */
        .img-preview-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: flex; 
            justify-content: center; align-items: center; cursor: zoom-out;
        }
        .img-preview { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 59, 42, 0.3); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-card { background: #fffbf0; padding: 40px; width: 360px; border-radius: 16px; box-shadow: 0 20px 40px rgba(91, 70, 54, 0.2); text-align: center; border: 1px solid var(--border); }
        .modal-input { width: 100%; padding: 12px 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; outline: none; background: #fff; }
        .modal-btn { width: 100%; margin-top: 10px; padding: 12px; background: var(--btn-primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; }
        .error-msg { color: #dc2626; font-size: 13px; margin-top: 15px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; opacity: 0.4; }
    </style>
</head>
<body>

<div id="app">
    <!-- å¤§å›¾é¢„è§ˆ -->
    <div class="img-preview-overlay" v-if="previewImg" @click="previewImg = null">
        <img :src="previewImg" class="img-preview">
    </div>

    <!-- ç™»å½•/æ³¨å†Œ -->
    <div class="modal-overlay" v-if="!currentUser">
        <div class="modal-card">
            <h2 style="margin-bottom: 10px; color: var(--text-main);">11s Chat</h2>
            <p style="margin-bottom: 20px; font-size: 14px; opacity: 0.7;">
                {{ isRegistering ? 'åˆ›å»ºä¸€ä¸ªæ–°è´¦å·' : 'ç™»å½•ä½ çš„è´¦å·' }}
            </p>
            <input type="text" class="modal-input" v-model="loginForm.username" placeholder="ç”¨æˆ·å" @keyup.enter="handleLogin">
            <input type="password" class="modal-input" v-model="loginForm.password" placeholder="å¯†ç " @keyup.enter="handleLogin">
            <button class="modal-btn" @click="handleLogin" :disabled="isLoading">{{ isLoading ? 'å¤„ç†ä¸­...' : (isRegistering ? 'æ³¨å†Œ' : 'ç™»å½•') }}</button>
            <div class="error-msg">{{ errorMessage }}</div>
            <div style="margin-top: 15px; font-size: 12px; color: #888; cursor: pointer;" @click="toggleMode">
                {{ isRegistering ? 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ' }}
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¥½å‹ -->
    <div class="modal-overlay" v-if="showAddFriendModal">
        <div class="modal-card">
            <h3 style="margin-bottom: 15px;">æ·»åŠ å¥½å‹</h3>
            <input type="text" class="modal-input" v-model="friendNameInput" placeholder="è¾“å…¥å¯¹æ–¹ç”¨æˆ·å..." @keyup.enter="addFriend">
            <button class="modal-btn" @click="addFriend" :disabled="isLoading">{{ isLoading ? 'æŸ¥æ‰¾ä¸­...' : 'æ·»åŠ ' }}</button>
            <div class="error-msg">{{ friendError }}</div>
            <button class="modal-btn" style="background:transparent; color:#666; margin-top:0;" @click="showAddFriendModal = false">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <template v-if="currentUser">
        <div class="sidebar">
            <div class="brand">
                <span><i class="bi bi-feather"></i> 11s Chat</span>
                <span class="conn-status" :class="{ online: isConnected }" title="è¿æ¥çŠ¶æ€"></span>
            </div>
            <div class="section-title">è”ç³»äºº <i class="bi bi-plus-circle-fill add-btn" @click="showAddFriendModal = true; friendError=''"></i></div>
            <div class="friend-list">
                <div v-for="friend in friends" :key="friend.id" class="friend-item" :class="{ active: currentChat?.id === friend.id }" @click="selectChat(friend)">
                    <div class="avatar">{{ friend.username.substring(0,1) }}</div>
                    <div>{{ friend.username }}</div>
                </div>
                <div v-if="friends.length === 0" style="text-align:center; margin-top:30px; font-size:13px; color:#999;">æš‚æ— å¥½å‹</div>
            </div>
            <div class="user-info">
                <div class="avatar" style="background:var(--text-main)">{{ currentUser.username.substring(0,1) }}</div>
                <div style="flex:1;">
                    <div style="font-weight:bold;">{{ currentUser.username }}</div>
                    <div style="font-size:11px; cursor:pointer; opacity:0.6;" @click="logout">é€€å‡º</div>
                </div>
            </div>
        </div>

        <div class="main-chat">
            <template v-if="currentChat">
                <div class="chat-header">{{ currentChat.username }}</div>
                <div class="chat-messages" id="msg-container">
                    <div v-for="msg in messages" :key="msg.id" class="message-bubble" :class="msg.sender_id === currentUser.id ? 'sent' : 'received'">
                        <!-- å›¾ç‰‡æ¶ˆæ¯ -->
                        <div v-if="msg.content.startsWith('img::')">
                            <img :src="msg.content.substring(5)" class="msg-img" @click="previewImg = msg.content.substring(5)">
                        </div>
                        <!-- æ–‡æœ¬æ¶ˆæ¯ -->
                        <div v-else>{{ msg.content }}</div>
                        <span class="msg-time">{{ formatTime(msg.created_at) }}</span>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ  -->
                <div class="chat-input-area">
                    <!-- å›¾ç‰‡ä¸Šä¼  -->
                    <button class="toolbar-btn" @click="triggerFileUpload" title="å‘é€å›¾ç‰‡">
                        <i class="bi bi-paperclip"></i>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none" @change="handleFileUpload">

                    <!-- è¡¨æƒ… -->
                    <button class="toolbar-btn" @click="showEmoji = !showEmoji" title="è¡¨æƒ…">
                        <i class="bi bi-emoji-smile"></i>
                    </button>
                    <div class="emoji-picker" v-if="showEmoji">
                        <div class="emoji-item" v-for="em in emojis" @click="addEmoji(em)">{{ em }}</div>
                    </div>

                    <input type="text" class="input-box" v-model="newMessage" placeholder="å†™ä¿¡..." @keyup.enter="sendMessage">
                    <button class="send-btn" @click="sendMessage"><i class="bi bi-send-fill"></i></button>
                </div>
            </template>
            <template v-else>
                <div class="empty-state">
                    <i class="bi bi-chat-square-quote empty-icon"></i>
                    <p>é€‰æ‹©ä¸€ä¸ªå¥½å‹å¼€å§‹èŠå¤©</p>
                </div>
            </template>
        </div>
    </template>
</div>

<script>
    const SUPABASE_URL = 'https://fznfneqwxzuwtognuoeo.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_UlNMDLt4OaYIX-_lCezGwA_8jIQLhFO'; 
    
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp, ref, onMounted, nextTick, onUnmounted } = Vue;

    const EMOJIS = ['ğŸ˜€','ğŸ˜‚','ğŸ¥°','ğŸ˜','ğŸ¤”','ğŸ˜¡','ğŸ˜­','ğŸ‘','ğŸ¤','ğŸ‰','ğŸ”¥','â¤ï¸','ğŸ“œ','ğŸ–Šï¸','â˜•','ğŸº','ğŸ•','ğŸ±','ğŸ¶','ğŸ¸','ğŸ‘»','ğŸ‘½','ğŸ¤–','ğŸ’©'];

    createApp({
        setup() {
            const currentUser = ref(null);
            const loginForm = ref({ username: '', password: '' });
            const isRegistering = ref(false);
            const isLoading = ref(false);
            const errorMessage = ref('');
            const friendError = ref('');
            const friends = ref([]);
            const currentChat = ref(null);
            const messages = ref([]);
            const newMessage = ref('');
            const showAddFriendModal = ref(false);
            const friendNameInput = ref('');
            const isConnected = ref(false);
            const showEmoji = ref(false);
            const previewImg = ref(null);
            const emojis = EMOJIS;
            let pollingInterval = null;

            onMounted(() => {
                const saved = localStorage.getItem('11s_user');
                if (saved) {
                    try { currentUser.value = JSON.parse(saved); loadFriends(); startPolling(); setupRealtime(); } catch(e) {}
                }
            });

            onUnmounted(() => {
                if (pollingInterval) clearInterval(pollingInterval);
            });

            const handleLogin = async () => {
                errorMessage.value = ''; 
                if(isLoading.value) return;
                const { username, password } = loginForm.value;
                if (!username || !password) { errorMessage.value = "è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç "; return; }
                
                isLoading.value = true;
                try {
                    if (isRegistering.value) {
                        const { data: exist } = await sb.from('chat_users').select('id').eq('username', username).maybeSingle();
                        if (exist) throw new Error("ç”¨æˆ·åå·²å­˜åœ¨");
                        const { data: newUser, error } = await sb.from('chat_users').insert({ username, password }).select().single();
                        if (error) throw error;
                        loginSuccess(newUser);
                    } else {
                        const { data: user, error } = await sb.from('chat_users').select('*').eq('username', username).maybeSingle();
                        if (error) throw error;
                        if (!user) throw new Error("ç”¨æˆ·ä¸å­˜åœ¨");
                        if (user.password !== password) throw new Error("å¯†ç é”™è¯¯");
                        loginSuccess(user);
                    }
                } catch (e) {
                    errorMessage.value = e.message || "æ“ä½œå¤±è´¥";
                } finally {
                    isLoading.value = false;
                }
            };

            const loginSuccess = (user) => {
                currentUser.value = user;
                localStorage.setItem('11s_user', JSON.stringify(user));
                loadFriends();
                startPolling();
                setupRealtime();
                loginForm.value = { username: '', password: '' };
            };

            const logout = () => {
                localStorage.removeItem('11s_user');
                currentUser.value = null;
                currentChat.value = null;
                if (pollingInterval) clearInterval(pollingInterval);
                sb.removeAllChannels();
            };

            const toggleMode = () => { isRegistering.value = !isRegistering.value; errorMessage.value = ''; };

            const loadFriends = async () => {
                const { data: f1 } = await sb.from('chat_friends').select('friend_id').eq('user_id', currentUser.value.id);
                const { data: f2 } = await sb.from('chat_friends').select('user_id').eq('friend_id', currentUser.value.id);
                const ids = [...new Set([...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)])];
                if (ids.length > 0) {
                    const { data } = await sb.from('chat_users').select('*').in('id', ids);
                    friends.value = data || [];
                }
            };

            const addFriend = async () => {
                if (!friendNameInput.value) return;
                isLoading.value = true;
                friendError.value = '';
                try {
                    const { data: target } = await sb.from('chat_users').select('*').eq('username', friendNameInput.value).maybeSingle();
                    if (!target) throw new Error("æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·");
                    if (target.id === currentUser.value.id) throw new Error("ä¸èƒ½æ·»åŠ è‡ªå·±");
                    const { error } = await sb.from('chat_friends').insert({ user_id: currentUser.value.id, friend_id: target.id });
                    if (error) throw new Error("æ·»åŠ å¤±è´¥ï¼ˆå¯èƒ½å·²ç»æ˜¯å¥½å‹äº†ï¼‰");
                    showAddFriendModal.value = false;
                    friendNameInput.value = '';
                    loadFriends();
                } catch (e) { friendError.value = e.message; } finally { isLoading.value = false; }
            };

            const selectChat = (friend) => { currentChat.value = friend; loadMessages(); };

            const loadMessages = async () => {
                if (!currentChat.value) return;
                const { data } = await sb.from('chat_messages')
                    .select('*')
                    .or(`sender_id.eq.${currentUser.value.id},receiver_id.eq.${currentUser.value.id}`)
                    .order('created_at', { ascending: true });
                messages.value = (data || []).filter(m => 
                    (m.sender_id === currentUser.value.id && m.receiver_id === currentChat.value.id) ||
                    (m.sender_id === currentChat.value.id && m.receiver_id === currentUser.value.id)
                );
                scrollToBottom();
            };

            const startPolling = () => {
                if (pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(() => { if (currentChat.value) loadMessages(); }, 3000);
            };

            // å‘é€æ–‡æœ¬
            const sendMessage = async () => {
                if (!newMessage.value.trim() || !currentChat.value) return;
                const content = newMessage.value;
                newMessage.value = '';
                showEmoji.value = false;
                
                // ä¹è§‚æ›´æ–°
                const tempMsg = { id: Date.now(), sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content: content, created_at: new Date().toISOString() };
                messages.value.push(tempMsg);
                scrollToBottom();

                await sb.from('chat_messages').insert({ sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content: content });
                loadMessages();
            };

            // å›¾ç‰‡ä¸Šä¼ 
            const triggerFileUpload = () => document.getElementById('fileInput').click();
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // ä¹è§‚æ›´æ–°ï¼ˆå…ˆæ˜¾ç¤º"ä¸Šä¼ ä¸­..."ï¼‰
                const tempMsg = { id: Date.now(), sender_id: currentUser.value.id, receiver_id: currentChat.value.id, content: "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...", created_at: new Date().toISOString() };
                messages.value.push(tempMsg);
                scrollToBottom();

                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    const { error: uploadError } = await sb.storage.from('chat-uploads').upload(fileName, file);
                    if (uploadError) throw uploadError;

                    const { data } = sb.storage.from('chat-uploads').getPublicUrl(fileName);
                    const publicUrl = data.publicUrl;

                    // å‘é€å¸¦å‰ç¼€çš„å›¾ç‰‡æ¶ˆæ¯
                    await sb.from('chat_messages').insert({
                        sender_id: currentUser.value.id,
                        receiver_id: currentChat.value.id,
                        content: `img::${publicUrl}`
                    });
                    
                    loadMessages(); // åˆ·æ–°æ˜¾ç¤ºçœŸå®å›¾ç‰‡
                } catch (error) {
                    alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: " + error.message);
                    messages.value.pop(); // ç§»é™¤ä¸´æ—¶æ¶ˆæ¯
                }
            };

            const addEmoji = (em) => { newMessage.value += em; };

            const setupRealtime = () => {
                sb.removeAllChannels();
                const channel = sb.channel('public:chat_messages');
                channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, payload => {
                    const msg = payload.new;
                    if (currentChat.value && 
                        ((msg.sender_id === currentUser.value.id && msg.receiver_id === currentChat.value.id) ||
                         (msg.sender_id === currentChat.value.id && msg.receiver_id === currentUser.value.id))) {
                        // ç®€å•å»é‡ï¼šå¦‚æœIDä¸ä¸€æ ·æ‰åŠ 
                        if (!messages.value.some(m => m.id === msg.id)) {
                            messages.value.push(msg);
                            scrollToBottom();
                        }
                    }
                })
                .subscribe((status) => {
                    isConnected.value = status === 'SUBSCRIBED';
                });
            };

            const scrollToBottom = () => { nextTick(() => { const c = document.getElementById('msg-container'); if(c) c.scrollTop = c.scrollHeight; }); };
            const formatTime = (iso) => { const d = new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };

            return {
                currentUser, loginForm, isRegistering, isLoading, errorMessage, friendError, friends, currentChat, messages, newMessage,
                showAddFriendModal, friendNameInput, isConnected, showEmoji, emojis, previewImg,
                handleLogin, logout, toggleMode, addFriend, selectChat, sendMessage, formatTime, 
                addEmoji, triggerFileUpload, handleFileUpload
            };
        }
    }).mount('#app');
</script>
</body>
</html>
